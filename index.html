<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e17">
<title>Hedonicum</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç∑</text></svg>">
<style>
:root{--bg:#0a0e17;--bg-card:#111827;--bg-el:#151d2e;--gold:#d4a96a;--gold-dim:rgba(212,169,106,.12);--gold-glow:rgba(212,169,106,.06);--gold-border:rgba(212,169,106,.2);--text:#e2e8f0;--text-m:#94a3b8;--text-d:#6b7a8d;--text-l:#3b4254;--border:#1e2538;--border-d:#1a1f2e;--green:#48bb78;--green-d:rgba(72,187,120,.15);--red:#e53e3e;--red-d:rgba(229,62,62,.1);--font:-apple-system,'system-ui','Segoe UI',Roboto,sans-serif}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:15px;overflow-x:hidden;-webkit-font-smoothing:antialiased}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 20px rgba(212,169,106,.05)}50%{box-shadow:0 0 40px rgba(212,169,106,.12)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes cardDismiss{0%{opacity:1;transform:translateX(0);max-height:200px;margin-bottom:8px;padding:16px}60%{opacity:0;transform:translateX(-80px)}100%{opacity:0;transform:translateX(-80px);max-height:0;margin-bottom:0;padding:0;border-width:0;overflow:hidden}}
@keyframes heartPop{0%{transform:scale(1)}30%{transform:scale(1.4)}60%{transform:scale(.95)}100%{transform:scale(1)}}
.app{max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;position:relative;padding-bottom:80px}
.toast{position:fixed;top:env(safe-area-inset-top,12px);left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);color:var(--text-d);padding:10px 24px;border-radius:12px;font-size:13px;z-index:99;animation:fadeIn .2s;backdrop-filter:blur(8px)}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:rgba(10,14,23,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1px solid var(--border-d);z-index:50;display:flex;padding:6px 0;padding-bottom:max(6px,env(safe-area-inset-bottom))}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 0;color:var(--text-d);font-size:10px;letter-spacing:.5px;cursor:pointer;background:none;border:none;font-family:var(--font);transition:color .2s}
.ni.on{color:var(--gold)}.ni-ic{font-size:20px;line-height:1}
.tab{display:none}.tab.on{display:block}
.hero{padding:32px 20px 20px;text-align:center;position:relative}
.hero::before{content:'';position:absolute;top:0;left:0;right:0;height:200px;background:radial-gradient(ellipse at center top,rgba(212,169,106,.06) 0%,transparent 70%);pointer-events:none}
.hero h1{font-size:36px;font-weight:800;color:var(--gold);letter-spacing:.5px;position:relative}
.hero .sub{color:var(--text-l);font-size:11px;letter-spacing:2.5px;text-transform:uppercase;margin-top:4px}
.identity{margin:20px 20px 0;background:var(--bg-card);border:1.5px solid var(--gold-border);border-radius:16px;padding:18px;position:relative;overflow:hidden;box-shadow:0 0 24px rgba(180,140,80,.08)}
.identity::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),rgba(212,169,106,.3),var(--gold));background-size:200% 100%;animation:shimmer 3s ease-in-out infinite}
.id-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.id-h{font-size:20px;font-weight:800}
.id-badge{font-size:10px;font-weight:700;color:var(--gold);border:1px solid var(--gold-border);padding:4px 12px;border-radius:20px;letter-spacing:.8px;text-transform:uppercase}
.id-bio{color:var(--text-m);font-size:13px;line-height:1.6}
.id-bio b{color:var(--text);font-weight:700}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:16px 20px 0}
.st{background:var(--bg-card);border:1px solid var(--border-d);border-radius:12px;padding:14px 6px;text-align:center;animation:countUp .5s ease-out both}
.st:nth-child(1){animation-delay:.1s}.st:nth-child(2){animation-delay:.15s}.st:nth-child(3){animation-delay:.2s}.st:nth-child(4){animation-delay:.25s}
.st-n{font-size:26px;font-weight:800;line-height:1;margin-bottom:3px}.st-n.g{color:var(--gold)}
.st-l{font-size:8px;color:var(--text-d);letter-spacing:1px;text-transform:uppercase;font-weight:600}
.sec{margin:24px 20px 0}.sec-h{font-size:11px;color:var(--text-l);letter-spacing:2px;text-transform:uppercase;font-weight:600;margin-bottom:12px}
.dna{display:flex;flex-wrap:wrap;gap:7px}
.dp{background:var(--gold-dim);border:1px solid var(--gold-border);border-radius:20px;padding:7px 14px;font-size:12px;color:var(--gold);font-weight:500;animation:slideIn .4s ease-out both}
.dp:nth-child(1){animation-delay:.1s}.dp:nth-child(2){animation-delay:.15s}.dp:nth-child(3){animation-delay:.2s}.dp:nth-child(4){animation-delay:.25s}.dp:nth-child(5){animation-delay:.3s}.dp:nth-child(6){animation-delay:.35s}
.cg{display:grid;grid-template-columns:repeat(2,1fr);gap:7px}
.cr{display:flex;align-items:center;justify-content:space-between;background:var(--bg-card);border:1px solid var(--border-d);border-radius:11px;padding:12px 14px;animation:fadeUp .4s ease-out both}
.cr:nth-child(1){animation-delay:.05s}.cr:nth-child(2){animation-delay:.1s}.cr:nth-child(3){animation-delay:.15s}.cr:nth-child(4){animation-delay:.2s}.cr:nth-child(5){animation-delay:.25s}.cr:nth-child(6){animation-delay:.3s}
.cf{font-size:16px;margin-right:7px}.cn{font-size:13px;font-weight:600;flex:1}.cc{font-size:14px;font-weight:800;color:var(--gold)}
.vr{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid var(--border-d);animation:fadeUp .3s ease-out both}.vr:last-child{border-bottom:none}
.vr-r{font-size:11px;font-weight:800;color:var(--text-l);min-width:18px}.vr-i{flex:1}.vr-n{font-size:14px;font-weight:700}.vr-m{font-size:11px;color:var(--text-d);margin-top:2px}
.vr-v{font-size:18px;font-weight:800;color:var(--gold)}.vr-vl{font-size:8px;color:var(--text-d);text-transform:uppercase;letter-spacing:.8px}
.disc{padding:32px 20px 20px}.disc-h{text-align:center;margin-bottom:20px}.disc-h h2{font-size:28px;font-weight:800;margin-bottom:4px}.disc-h p{color:var(--text-d);font-size:13px}
.pow{display:flex;align-items:center;gap:10px;background:var(--bg-card);border:1px solid var(--border-d);border-radius:12px;padding:10px 14px;margin-bottom:16px}
.pow-av{width:26px;height:26px;background:var(--gold-dim);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px}
.pow-t{font-size:11px;color:var(--text-d)}.pow-t b{color:var(--gold);font-weight:600}
.im{width:100%;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;color:var(--text);font-family:var(--font);font-size:17px;padding:16px 20px;outline:none;margin-bottom:10px}
.im::placeholder{color:var(--text-d)}.im:focus{border-color:var(--gold-border)}
.is{width:100%;background:var(--bg-card);border:1px solid var(--border-d);border-radius:12px;color:var(--text-m);font-family:var(--font);font-size:13px;padding:12px 16px;outline:none;margin-bottom:12px}
.is::placeholder{color:var(--text-d)}
.fr{display:flex;gap:6px;margin-bottom:10px}
.fb{flex:1;background:transparent;border:1px solid var(--border-d);border-radius:10px;color:var(--text-d);font-family:var(--font);font-size:13px;padding:10px;text-align:center;cursor:pointer;font-weight:500;transition:all .2s}
.fb.on{background:var(--gold-dim);border-color:var(--gold-border);color:var(--gold)}.fb:active{transform:scale(.96)}
.go{width:100%;background:var(--gold);color:var(--bg);border:none;border-radius:12px;padding:14px;font-family:var(--font);font-size:15px;font-weight:700;cursor:pointer;margin-bottom:14px}
.go:active{transform:scale(.97);opacity:.9}.go:disabled{opacity:.5;cursor:wait}
.tbar{display:flex;justify-content:space-between;align-items:center;padding:6px 0;margin-bottom:10px}
.tbar-s{font-size:11px;color:var(--text-d)}.tbar-s .lv{color:#e53e3e}.tbar-s .rj{color:var(--text-d)}
.tbar-r{background:transparent;border:none;color:var(--text-d);font-size:10px;cursor:pointer;font-family:var(--font);padding:4px 8px;border-radius:6px}
.ld{text-align:center;padding:48px 0;animation:pulse 2s ease-in-out infinite}.ld-t{font-size:15px;font-weight:600;color:var(--text-d)}.ld-s{color:var(--text-l);font-size:12px;margin-top:6px}
.err{color:var(--red);text-align:center;padding:20px;font-size:14px}
.cv{background:var(--bg-card);border-radius:16px;padding:18px;margin-bottom:14px;border-left:3px solid var(--gold-border)}.cv p{color:var(--text-m);font-size:13px;line-height:1.7}
.rc{background:var(--bg-card);border:1px solid var(--border-d);border-radius:14px;padding:16px;margin-bottom:8px;transition:all .3s;position:relative}
.rc.lc{border-color:rgba(229,62,62,.35);background:rgba(229,62,62,.04)}.rc.xc{animation:cardDismiss .45s ease-out forwards;pointer-events:none}
.rc-top{display:flex;justify-content:space-between;align-items:flex-start}.rc-i{flex:1;min-width:0}
.rc-nr{display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.rc-nm{font-size:15px;font-weight:700;color:var(--text);text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;display:block}
.rc-nm:active{color:var(--gold)}.rc-cu{font-size:11px;color:var(--text-d);font-weight:500}.rc-pr{font-size:11px;color:var(--green);font-weight:600}
.rc-loc{color:var(--text-l);font-size:11px;margin-top:3px}
.rc-act{display:flex;align-items:center;gap:5px;flex-shrink:0}
.ab{background:transparent;border:1px solid var(--border-d);border-radius:10px;width:34px;height:34px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;color:var(--text-d)}
.ab:active{transform:scale(.9)}.ab.lo{background:rgba(229,62,62,.15);border-color:rgba(229,62,62,.4);color:#e53e3e;animation:heartPop .35s ease-out}.ab.xo{background:var(--red-d);border-color:rgba(229,62,62,.2);color:var(--red)}
.rc-sc{text-align:center;min-width:34px}.sn{font-size:26px;font-weight:800;line-height:1}
.s9{color:var(--gold)}.s7{color:#b8956a}.s5{color:var(--text-d)}.sl{color:var(--text-l)}
.rc-sp{color:var(--text-m);font-size:12px;line-height:1.5;margin-top:8px}
.rc-mp{color:var(--gold);font-size:11px;text-decoration:none;display:inline-block;margin-top:8px;opacity:.6;font-weight:500}
.rf{text-align:center;margin:32px 0 16px;color:var(--text-l);font-size:10px;letter-spacing:1px}
.es{text-align:center;padding:16px 0}.es p{color:var(--text-d);font-size:15px;line-height:1.6;font-weight:300}
.cp{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin-top:18px}
.cpl{background:transparent;border:1px solid var(--border);border-radius:20px;color:var(--text-d);font-family:var(--font);font-size:13px;padding:8px 16px;cursor:pointer;font-weight:500}
.cpl:active{border-color:var(--gold-border);color:var(--gold);transform:scale(.96)}
.scan{padding:32px 20px 20px}.scan h2{font-size:28px;font-weight:800;text-align:center;margin-bottom:4px}
.scan .sh-p{color:var(--text-d);font-size:13px;text-align:center;margin-bottom:24px}
.scan-cta{background:var(--gold);border-radius:16px;padding:36px 20px;text-align:center;cursor:pointer;margin-bottom:14px;animation:pulseGlow 3s ease-in-out infinite;border:none;width:100%;font-family:var(--font)}
.scan-cta .si{font-size:44px;margin-bottom:10px}.scan-cta h3{font-size:18px;font-weight:700;color:var(--bg)}
.scan-cta p{font-size:12px;color:rgba(10,14,23,.6);margin-top:4px}
.scan-alt{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;align-items:center;gap:14px;cursor:pointer}
.scan-alt .sa-i{font-size:26px}.scan-alt h3{font-size:15px;font-weight:700}.scan-alt p{font-size:11px;color:var(--text-d);margin-top:2px}
.scan-photos{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.scan-thumb{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
.scan-thumb-wrap{position:relative}
.scan-thumb-x{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.scan-add-more{display:inline-flex;align-items:center;gap:6px;background:transparent;border:1px dashed var(--border);border-radius:10px;color:var(--text-d);font-family:var(--font);font-size:12px;padding:8px 14px;cursor:pointer;margin-bottom:12px}
.scan-wine{background:var(--bg-card);border:1px solid var(--border-d);border-radius:14px;padding:14px 16px;margin-bottom:8px;animation:fadeUp .3s ease-out both}
.scan-wine .sw-top{display:flex;justify-content:space-between;align-items:flex-start}
.scan-wine .sw-name{font-size:14px;font-weight:700;flex:1}
.scan-wine .sw-score{font-size:22px;font-weight:800;min-width:30px;text-align:right}
.scan-wine .sw-meta{font-size:11px;color:var(--text-d);margin-top:3px}
.scan-wine .sw-note{font-size:12px;color:var(--text-m);margin-top:6px;line-height:1.5}
.scan-wine .sw-pair{font-size:11px;color:var(--green);margin-top:4px}
.scan-bottle-card{background:var(--bg-card);border:1px solid var(--gold-border);border-radius:16px;padding:20px;animation:fadeUp .4s ease-out}
.scan-bottle-card h3{font-size:18px;font-weight:800;margin-bottom:2px}
.scan-bottle-card .sb-winery{font-size:13px;color:var(--gold);font-weight:600}
.scan-bottle-card .sb-detail{font-size:12px;color:var(--text-d);margin-top:8px;line-height:1.6}
.scan-bottle-card .sb-notes{font-size:13px;color:var(--text-m);margin-top:10px;line-height:1.6;font-style:italic}
.cel{padding:32px 20px 20px}.cel h2{font-size:28px;font-weight:800;margin-bottom:2px}.cel .ch-p{color:var(--text-d);font-size:13px;margin-bottom:16px}
.cel-f{display:flex;gap:6px;margin-bottom:14px}
.cft{background:transparent;border:1px solid var(--border-d);border-radius:10px;color:var(--text-d);font-family:var(--font);font-size:12px;padding:8px 14px;cursor:pointer;font-weight:500}
.cft.on{background:var(--gold-dim);border-color:var(--gold-border);color:var(--gold)}
.wr{display:flex;align-items:center;padding:13px 0;border-bottom:1px solid var(--border-d);animation:fadeUp .3s ease-out both}.wr:last-child{border-bottom:none}
.wr-i{flex:1}.wr-n{font-size:14px;font-weight:700}.wr-m{font-size:11px;color:var(--text-d);margin-top:2px}
.ws{font-size:24px;font-weight:800}.ws.w5{color:var(--gold)}.ws.w4{color:#b8956a}
.wt{font-size:8px;color:var(--gold);letter-spacing:.5px;font-weight:700}
.pb20{padding-bottom:20px}
.cr{cursor:pointer;transition:all .2s}.cr:active{transform:scale(.97)}
.cr-exp{overflow:hidden;transition:max-height .35s ease,opacity .3s;max-height:0;opacity:0}
.cr-exp.open{max-height:600px;opacity:1}
.cr-v{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:12px;color:var(--text-m);border-bottom:1px solid var(--border-d)}.cr-v:last-child{border:none}
.cr-v .cv-n{flex:1;font-weight:600;color:var(--text)}.cr-v .cv-c{color:var(--text-d);font-size:11px}.cr-v .cv-l{color:var(--text-l);font-size:10px}
.cr-arr{font-size:10px;color:var(--text-d);transition:transform .2s}.cr-arr.op{transform:rotate(90deg)}
.feed-card{background:var(--bg-card);border:1px solid var(--border-d);border-radius:14px;padding:14px 16px;margin-bottom:8px;animation:fadeUp .4s ease-out both;display:flex;align-items:center;gap:12px}
.feed-card .fc-flag{font-size:20px;flex-shrink:0}
.feed-card .fc-info{flex:1;min-width:0}
.feed-card .fc-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.feed-card .fc-meta{font-size:11px;color:var(--text-d);margin-top:2px}
.feed-card .fc-loc{font-size:10px;color:var(--text-l);margin-top:1px}

</style>
</head>
<body>
<div class="app" id="app"></div>
<script>
const API="https://wine-profile.vercel.app/api/analyze";
const SB_URL="https://bzpraigsuwgjgpnclcpd.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cHJhaWdzdXdnamdwbmNsY3BkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mzk2NDEsImV4cCI6MjA4NTExNTY0MX0.tBtsac6Mq65BiG93MhYtn1KV8iOGpEpVdlD3tqShrzE";
const CW=[{n:'Alonso del Yerro Mar√≠a Ribera del Duero',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Bodegas Alvia Ribeira Sacra Mencia',r:'Ribeira Sacra, Spain',c:'Spain',g:'Mencia',v:null,t:5}, {n:'Bodegas Frontaura Crianza',r:'Toro, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Bogle Old Vine Zinfandel',r:'California, United States',c:'United States',g:'Zinfandel',v:null,t:5}, {n:'Caymus Vineyards Cabernet Sauvignon',r:'Napa Valley, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:5}, {n:'Ch√¢teau Moulin de la Grang√®re Saint-√âmilion Grand Cru',r:'Saint-√âmilion Grand Cru, France',c:'France',g:'Merlot',v:null,t:5}, {n:'Cordella Brunello di Montalcino',r:'Brunello di Montalcino, Italy',c:'Italy',g:'Sangiovese',v:null,t:5}, {n:'El Enemigo Gran Enemigo Single Vineyard Chacayes Cabernet Franc',r:'Tunuy√°n, Argentina',c:'Argentina',g:'Cabernet Franc',v:null,t:5}, {n:'Hacienda Grimon Finca la Oracion',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Hess Las Fincas Rosado',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Imperial Rioja Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Italo Cescon Pinot Noir Il Tralcetto',r:'Veneto, Italy',c:'Italy',g:'Pinot Noir',v:null,t:5}, {n:'La Crema Sonoma Coast Pinot Noir',r:'Sonoma Coast, United States',c:'United States',g:'Pinot Noir',v:null,t:5}, {n:'La Rioja Alta Vi√±a Ardanza Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Les Cailloux Bordeaux Blanc',r:'Bordeaux, France',c:'France',g:'Sauvignon Blanc',v:null,t:5}, {n:'Marques de Vargas Reserva Privada Rioja',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Matarromera Ribera del Duero Reserva',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Mateus Dry Ros√© Seco Sec',r:'Douro, Portugal',c:'Portugal',g:'Unknown',v:null,t:5}, {n:'Mateus The Original Ros√©',r:'Douro, Portugal',c:'Portugal',g:'Touriga Nacional',v:null,t:5}, {n:'Mer Soleil Reserve Pinot Noir',r:'Santa Lucia Highlands, United States',c:'United States',g:'Pinot Noir',v:null,t:5}, {n:'Miraval C√¥tes de Provence Ros√©',r:'C√¥tes de Provence, France',c:'France',g:'Grenache',v:null,t:5}, {n:'Muga Selecci√≥n Especial Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Niepoort Douro Vertente Tinto',r:'Douro, Portugal',c:'Portugal',g:'Touriga Nacional',v:null,t:5}, {n:'Pago de Carraovejas Tinto',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Ram√≥n Bilbao The Journey Collection Reserva Especial',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Relic Ritual',r:'Napa Valley, United States',c:'United States',g:'Unknown',v:null,t:5}, {n:'Remelluri Rioja Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:5}, {n:'Siete Fincas Malbec',r:'Mendoza, Argentina',c:'Argentina',g:'Malbec',v:null,t:5}, {n:'Varda Vineyards Pinot Noir',r:'Sonoma County, United States',c:'United States',g:'Pinot Noir',v:null,t:5}, {n:'Vi√±a Vik Winery Milla Cala',r:'Cachapoal Valley, Chile',c:'Chile',g:'Unknown',v:null,t:5}, {n:'Agricola Arm√≤nja Corte Sant\'Elia Primitivo',r:'Gioia del Colle, Italy',c:'Italy',g:'Primitivo',v:null,t:4.5}, {n:'Ang√©lica Zapata Chardonnay Alta',r:'Mendoza, Argentina',c:'Argentina',g:'Chardonnay',v:null,t:4.5}, {n:'Azienda San Martino Siir Aglianico del Vulture',r:'Aglianico del Vulture, Italy',c:'Italy',g:'Aglianico',v:null,t:4.5}, {n:'Bodega Ca\'n Verdura Supernova Mantonegro',r:'Binissalem-Mallorca, Spain',c:'Spain',g:'Mantonegro',v:null,t:4.5}, {n:'Bodegas Carrau Juan Carrau Gran Reserva Tannat-Cabernet',r:'Montevideo, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4.5}, {n:'Bodegas Pe√±afiel Miros de Ribera Crianza',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Bouza Tempranillo-Tannat',r:'Montevideo, Uruguay',c:'Uruguay',g:'Tempranillo',v:null,t:4.5}, {n:'Bruno Murciano L\'Alegria Bobal Arcilla',r:'Utiel-Requena, Spain',c:'Spain',g:'Bobal',v:null,t:4.5}, {n:'Cantina Bozen Lagrein Prestige Riserva',r:'S√ºdtirol-Alto Adige, Italy',c:'Italy',g:'Lagrein',v:null,t:4.5}, {n:'Carmelo Rodero Crianza',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Casa Ferreirinha Callabriga Douro',r:'Douro, Portugal',c:'Portugal',g:'Touriga Nacional',v:null,t:4.5}, {n:'Castillo de Cuzcurrita Se√±or√≠o de Cuzcurrita',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Ch√¢teau Moncets Lalande de Pomerol',r:'Lalande-de-Pomerol, France',c:'France',g:'Merlot',v:null,t:4.5}, {n:'Corte Sant\'Alda Campi Magri Valpolicella Ripasso',r:'Valpolicella Ripasso, Italy',c:'Italy',g:'Corvina',v:null,t:4.5}, {n:'Dominio de Pingus PSI',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Famille Perrin Ch√¢teauneuf-du-Pape Les Sinards',r:'Ch√¢teauneuf-du-Pape, France',c:'France',g:'Grenache',v:null,t:4.5}, {n:'Hacienda Grimon Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Izarbe Reserva Vendimia Seleccionada',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Jean Fournier Marsannay Clos du Roy',r:'Marsannay, France',c:'France',g:'Pinot Noir',v:null,t:4.5}, {n:'L\'Arco Arcum Rosso Veronese',r:'Rosso Veronese, Italy',c:'Italy',g:'Corvina',v:null,t:4.5}, {n:'Los Aguilares Pago El Espino',r:'Sierras de M√°laga, Spain',c:'Spain',g:'Unknown',v:null,t:4.5}, {n:'Louis Latour Meursault Rouge',r:'Meursault, France',c:'France',g:'Pinot Noir',v:null,t:4.5}, {n:'Luis Ca√±as Reserva Selecci√≥n de la Familia',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Madirazza Grande Riserva Polozaj Dingaƒç',r:'Dingaƒç, Croatia',c:'Croatia',g:'Plavac Mali',v:null,t:4.5}, {n:'Masca del Tacco Li Filitti Riserva Primitivo di Manduria',r:'Primitivo di Manduria, Italy',c:'Italy',g:'Primitivo',v:null,t:4.5}, {n:'Montecillo Fuenmayor',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Monteraponi Chianti Classico',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4.5}, {n:'Poderi dal Nespoli Prugneto Sangiovese di Romagna',r:'Romagna, Italy',c:'Italy',g:'Sangiovese',v:null,t:4.5}, {n:'Podrum Vujnoviƒá Ivan Dolac',r:'Ivan Dolac, Croatia',c:'Croatia',g:'Plavac Mali',v:null,t:4.5}, {n:'Prackfol S√ºdtiroler Blauburgunder',r:'Trentino-Alto Adige, Italy',c:'Italy',g:'Pinot Noir',v:null,t:4.5}, {n:'Reguta Giuseppe e Luigi Pinot Bianco',r:'Friuli, Italy',c:'Italy',g:'Pinot Bianco',v:null,t:4.5}, {n:'Santa Margherita Chianti Classico Riserva',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4.5}, {n:'Scheiblhofer Big John Cuv√©e Reserve',r:'Burgenland, Austria',c:'Austria',g:'Unknown',v:null,t:4.5}, {n:'Tenuta Ferrata Cim√® Rosato',r:'Etna, Italy',c:'Italy',g:'Nerello Mascalese',v:null,t:4.5}, {n:'Tinto Pesquera Crianza',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4.5}, {n:'Vantorosso Valpolicella Ripasso Classico Superiore',r:'Valpolicella Ripasso, Italy',c:'Italy',g:'Corvina',v:null,t:4.5}, {n:'Zorzal Terroir √önico Pinot Noir',r:'Tupungato, Argentina',c:'Argentina',g:'Pinot Noir',v:null,t:4.5}, {n:'Aalto Ribera del Duero',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Aldegheri I Lastari Valpolicella Classico Superiore',r:'Valpolicella Classico, Italy',c:'Italy',g:'Corvina',v:null,t:4}, {n:'Allende Rioja',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Altos de Rioja Crianza',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Altos de Rioja Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Annabella Pinot Noir Special Selection',r:'Los Carneros, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Antica Enotria Falanghina',r:'Puglia, Italy',c:'Italy',g:'Falanghina',v:null,t:4}, {n:'Antinori Tenuta Tignanello Chianti Classico Riserva',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Artesana Tannat',r:'Canelones, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Austin Hope Cabernet Sauvignon',r:'Paso Robles, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Azienda Agraria Carini Tegolaro',r:'Umbria, Italy',c:'Italy',g:'Unknown',v:null,t:4}, {n:'Bai Gorri',r:'Rioja',c:'Spain',g:'Tempranillo',v:2020,t:4}, {n:'Banfi Brunello di Montalcino',r:'Brunello di Montalcino, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Benanti Etna Rosso',r:'Etna, Italy',c:'Italy',g:'Nerello Mascalese',v:null,t:4}, {n:'Benziger Pinot Noir',r:'Sonoma Coast, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Beringer Knights Valley Cabernet Sauvignon',r:'Knights Valley, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Bicicletas y Peces Tempranillo Ros√©',r:'Somontano, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Bloodroot Cellars Pinot Noir',r:'Sonoma County, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Bodega Garz√≥n Reserva Marselan',r:'Maldonado, Uruguay',c:'Uruguay',g:'Marselan',v:null,t:4}, {n:'Bodega Garz√≥n Single Vineyard Tannat',r:'Maldonado, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Bodegas Carrau Amat Tannat',r:'Rivera, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Bodegas Carrau Edici√≥n Limitada Tannat Reserva',r:'Montevideo, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Bodegas Frontaura Nexus One',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Bodegas LAN D-12',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Bodegas Luz√≥n Antigua Fontana Cabernet Sauvignon',r:'Jumilla, Spain',c:'Spain',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Bodegas Manzanos Finca Manzanos Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Bodegas Marqu√©s de C√°ceres Gran Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Bodegas Pr√≠ncipe de Viana Vendimia Seleccionada Crianza',r:'Navarra, Spain',c:'Spain',g:'Unknown',v:null,t:4}, {n:'Bodegas y Vi√±edos Pintia Pintia',r:'Toro, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Borsao Tres Picos Garnacha',r:'Campo de Borja, Spain',c:'Spain',g:'Garnacha',v:null,t:4}, {n:'Bouza Tannat',r:'Montevideo, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Callejo Flores de Callejo',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Campo Viejo Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Cantele Teresamanara Negroamaro',r:'Salento, Italy',c:'Italy',g:'Negroamaro',v:null,t:4}, {n:'Cantine Astroni Vigna Astroni Piedirosso',r:'Campi Flegrei, Italy',c:'Italy',g:'Piedirosso',v:null,t:4}, {n:'Cantine San Marzano Talo Primitivo di Manduria',r:'Primitivo di Manduria, Italy',c:'Italy',g:'Primitivo',v:null,t:4}, {n:'Carmelo Rodero Ribera del Duero TSM',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Carmelo Rodero Ribiera del Duero Crianza',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Castello di Volpaia Chianti Classico',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Clos de Fous Pour Ma Gueule Pinot Noir',r:'Aconcagua Valley, Chile',c:'Chile',g:'Pinot Noir',v:null,t:4}, {n:'Colli Della Murgia Tufjano',r:'Puglia, Italy',c:'Italy',g:'Unknown',v:null,t:4}, {n:'Columbia Crest Reserve Cabernet Sauvignon',r:'Columbia Valley, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Comenge Biberius',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Cono Sur 20 Barrels Pinot Noir',r:'Casablanca Valley, Chile',c:'Chile',g:'Pinot Noir',v:null,t:4}, {n:'Contini I Giganti',r:'Valle del Tirso, Italy',c:'Italy',g:'Vernaccia',v:null,t:4}, {n:'Cotarella Ferentano Lazio',r:'Lazio, Italy',c:'Italy',g:'Unknown',v:null,t:4}, {n:'Cottanera Etna Calderara Bianco',r:'Etna, Italy',c:'Italy',g:'Carricante',v:null,t:4}, {n:'Cousi√±o-Macul Antiguas Reservas Cabernet Sauvignon',r:'Maipo Valley, Chile',c:'Chile',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Cune Imperial Gran Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Cusumano Alta Mora Etna Bianco',r:'Etna, Italy',c:'Italy',g:'Carricante',v:null,t:4}, {n:'Cusumano Alta Mora Guardiola Etna Rosso',r:'Etna, Italy',c:'Italy',g:'Nerello Mascalese',v:null,t:4}, {n:'Domaine des Ouled Thaleb Tandem Syrah du Maroc',r:'Zenatta, Morocco',c:'Morocco',g:'Syrah',v:null,t:4}, {n:'Domaine Marcel Lapierre Cuv√©e Marcel Morgon',r:'Morgon, France',c:'France',g:'Gamay',v:null,t:4}, {n:'Dominio do Bibei Lapola',r:'Ribeira Sacra, Spain',c:'Spain',g:'Menc√≠a',v:null,t:4}, {n:'Donnafugata Mille e una Notte',r:'Sicilia, Italy',c:'Italy',g:'Nero d\'Avola',v:null,t:4}, {n:'Emiliana Coyam',r:'Colchagua Valley, Chile',c:'Chile',g:'Syrah',v:null,t:4}, {n:'Familia Irurtia Posada del Virrey Tannat',r:'Carmelo, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Famille Berrouet Ch√¢teau Samion Lalande de Pomerol',r:'Lalande-de-Pomerol, France',c:'France',g:'Merlot',v:null,t:4}, {n:'Feudi di San Gregorio Falanghina',r:'Falanghina del Sannio, Italy',c:'Italy',g:'Falanghina',v:null,t:4}, {n:'Feudi di San Gregorio Rubrato Aglianico',r:'Irpinia, Italy',c:'Italy',g:'Aglianico',v:null,t:4}, {n:'Finca Allende Rioja',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Finca del Castillo Tempranillo',r:'La Mancha, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Finca Sobreno Crianza',r:'Toro, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Finca Sobreno Pago Lencia Crianza',r:'Toro, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Firriato Harmonium Nero d\'Avola',r:'Sicilia, Italy',c:'Italy',g:'Nero d\'Avola',v:null,t:4}, {n:'Flaherty Red Blend',r:'Aconcagua Valley, Chile',c:'Chile',g:'Unknown',v:null,t:4}, {n:'Francis Ford Coppola Director\'s Cut Pinot Noir',r:'Sonoma Coast, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Frescobaldi Nipozzano Chianti Rufina Riserva',r:'Chianti Rufina, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Garz√≥n Tannat Reserva',r:'Maldonado, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Gimenez Mendez Alta Reserva Tannat',r:'Canelones, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'H. Stagnari Tannat Viejo',r:'Canelones, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Hacienda Monasterio Reserva Especial',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Hess Allomi Cabernet Sauvignon',r:'Napa Valley, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Hess Select Pinot Noir',r:'Monterey, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Il Poggione Brunello di Montalcino',r:'Brunello di Montalcino, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Jean Foillard Morgon',r:'Morgon, France',c:'France',g:'Gamay',v:null,t:4}, {n:'Jean-Paul Th√©venet Vieilles Vignes Morgon',r:'Morgon, France',c:'France',g:'Gamay',v:null,t:4}, {n:'Juanic√≥ Don Pascual Tannat Reserva',r:'Canelones, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Juggernaut Hillside Cabernet Sauvignon',r:'California, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Lafken Single Vineyard Carm√©n√®re',r:'Maipo Valley, Chile',c:'Chile',g:'Carm√©n√®re',v:null,t:4}, {n:'Lapostolle Cuv√©e Alexandre Carmen√®re',r:'Colchagua Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:4}, {n:'Larchago Crianza',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Li Veli Orion Primitivo',r:'Salento, Italy',c:'Italy',g:'Primitivo',v:null,t:4}, {n:'Librandi Gravello',r:'Val di Neto, Italy',c:'Italy',g:'Gaglioppo',v:null,t:4}, {n:'Luis Ca√±as Crianza',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Manzoni Home Vineyard Pinot Noir',r:'Santa Lucia Highlands, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Mar de Frades Albari√±o Atlantico',r:'R√≠as Baixas, Spain',c:'Spain',g:'Albari√±o',v:null,t:4}, {n:'Marichal Tannat Reserva',r:'Canelones, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Marqu√©s de C√°ceres Crianza',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Marqu√©s de C√°ceres Ollamendi Crianza',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Marqu√©s de C√°ceres Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Marqu√©s de Riscal Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Masseria Borgo dei Trulli Primitivo di Manduria',r:'Primitivo di Manduria, Italy',c:'Italy',g:'Primitivo',v:null,t:4}, {n:'Mastroberardino Radici Taurasi',r:'Taurasi, Italy',c:'Italy',g:'Aglianico',v:null,t:4}, {n:'Matarromera Ribera del Duero Crianza',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'M√©nage √† Trois Bourbon Barrel Cabernet Sauvignon',r:'California, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:4}, {n:'Mendel Malbec',r:'Mendoza, Argentina',c:'Argentina',g:'Malbec',v:null,t:4}, {n:'Michel Laurent Muscadet-S√®vre et Maine',r:'Muscadet, France',c:'France',g:'Melon',v:null,t:4}, {n:'Muga Prado Enea Gran Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Muga Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Narbona Pinot Noir',r:'Carmelo, Uruguay',c:'Uruguay',g:'Pinot Noir',v:null,t:4}, {n:'Otronia 45 Rugientes Pinot Noir',r:'Patagonia, Argentina',c:'Argentina',g:'Pinot Noir',v:null,t:4}, {n:'Palacios Remondo La Montesa',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Palacios Remondo Rioja Alfaro R',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Pasqua 11 Minutes Ros√©',r:'Trevenezie, Italy',c:'Italy',g:'Corvina',v:null,t:4}, {n:'Pasqua PassioneSentimento Rosso',r:'Veneto, Italy',c:'Italy',g:'Corvina',v:null,t:4}, {n:'Phelps Creek Pinot Noir',r:'Columbia Gorge, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Pisano RPF Tannat',r:'Progreso, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Planeta Plumbago Nero d\'Avola',r:'Sicilia, Italy',c:'Italy',g:'Nero d\'Avola',v:null,t:4}, {n:'Podere Poggio Scalette Il Carbonaione',r:'Toscana, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Poggio le Volpi Baccarossa',r:'Lazio, Italy',c:'Italy',g:'Unknown',v:null,t:4}, {n:'Protos Tinto Fino',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Quinta do Vale Me√£o Meandro Douro Tinto',r:'Douro, Portugal',c:'Portugal',g:'Touriga Nacional',v:null,t:4}, {n:'Quinta do Vallado Tinto',r:'Douro, Portugal',c:'Portugal',g:'Unknown',v:null,t:4}, {n:'R. L√≥pez de Heredia Vi√±a Tondonia Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Rabasco Cancelli Rosso',r:'Abruzzo, Italy',c:'Italy',g:'Montepulciano',v:null,t:4}, {n:'Ram√≥n Bilbao Crianza',r:'Rioja',c:'Spain',g:'Tempranillo',v:2021,t:4}, {n:'Ram√≥n Bilbao Reserva 2018',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Rivera Il Falcone Castel del Monte Riserva',r:'Castel del Monte, Italy',c:'Italy',g:'Nero di Troia',v:null,t:4}, {n:'Rodney Strong Reserve Pinot Noir',r:'Russian River Valley, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Rodney Strong Sonoma Vineyards Red Blend',r:'Sonoma County, United States',c:'United States',g:'Unknown',v:null,t:4}, {n:'Ruffino Riserva Ducale Chianti Classico',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'San Felice Il Grigio Chianti Classico Riserva',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'San Salvatore Pian di Stio Fiano',r:'Paestum, Italy',c:'Italy',g:'Fiano',v:null,t:4}, {n:'Santa Ema Gran Reserva Carmen√®re',r:'Cachapoal Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:4}, {n:'Santa Julia Malbec Reserva',r:'Mendoza, Argentina',c:'Argentina',g:'Malbec',v:null,t:4}, {n:'Sasso di Sole Brunello di Montalcino',r:'Brunello di Montalcino, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Starmont Pinot Noir',r:'Carneros, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Tasca d\'Almerita Regaleali Nero d\'Avola',r:'Sicilia, Italy',c:'Italy',g:'Nero d\'Avola',v:null,t:4}, {n:'Tasca d\'Almerita Regaleali Rosato',r:'Terre Siciliane, Italy',c:'Italy',g:'Nero d\'Avola',v:null,t:4}, {n:'Telmo Rodr√≠guez Pegaso Barrancos de Pizarra',r:'Sierra de Gredos, Spain',c:'Spain',g:'Garnacha',v:null,t:4}, {n:'Tenute Filippi Enea Nero Buono',r:'Lazio, Italy',c:'Italy',g:'Nero Buono',v:null,t:4}, {n:'Terra Noble Gran Reserva Carmen√®re',r:'Colchagua Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:4}, {n:'Terrazas de los Andes Reserva Malbec',r:'Mendoza, Argentina',c:'Argentina',g:'Malbec',v:null,t:4}, {n:'Terredora di Paolo Falanghina',r:'Irpinia, Italy',c:'Italy',g:'Falanghina',v:null,t:4}, {n:'Terrunyo Carmen√®re',r:'Cachapoal Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:4}, {n:'Tormaresca Bocca di Lupo Aglianico',r:'Castel del Monte, Italy',c:'Italy',g:'Aglianico',v:null,t:4}, {n:'Tormaresca Neprica Primitivo',r:'Puglia, Italy',c:'Italy',g:'Primitivo',v:null,t:4}, {n:'Torre de O√±a Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'unknown Il Gabai Valpolicella Ripasso',r:'Valpolicella Ripasso, Italy',c:'Italy',g:'Corvina',v:null,t:4}, {n:'unknown La Piazza Rosso Veronese',r:'Rosso Veronese, Italy',c:'Italy',g:'Corvina',v:null,t:4}, {n:'Verveine Pinot Noir',r:'Anderson Valley, United States',c:'United States',g:'Pinot Noir',v:null,t:4}, {n:'Vietti Barbera d\'Asti La Crena',r:'Barbera d\'Asti, Italy',c:'Italy',g:'Barbera',v:null,t:4}, {n:'Villa Antinori Toscana',r:'Toscana, Italy',c:'Italy',g:'Sangiovese',v:null,t:4}, {n:'Vi√±a Alberdi Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Vi√±a Pomal Terru√±o Centenario Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Vi√±a Real Gran Reserva',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:4}, {n:'Vi√±edo de los Vientos Alcyone Tannat',r:'Atl√°ntida, Uruguay',c:'Uruguay',g:'Tannat',v:null,t:4}, {n:'Zlatan Otok Crljenak',r:'Hvar, Croatia',c:'Croatia',g:'Zinfandel',v:null,t:4}, {n:'Hess Select Cabernet Sauvignon',r:'North Coast, United States',c:'United States',g:'Cabernet Sauvignon',v:null,t:3.5}, {n:'Ram√≥n Bilbao Crianza Rioja',r:'Rioja, Spain',c:'Spain',g:'Tempranillo',v:null,t:3.5}, {n:'Sensi Collezione Chianti',r:'Chianti, Italy',c:'Italy',g:'Sangiovese',v:null,t:3.5}, {n:'Cantaburros Roble',r:'Ribera del Duero, Spain',c:'Spain',g:'Tempranillo',v:null,t:3}, {n:'Cantina Ferracci Ave Petrus',r:'Lazio, Italy',c:'Italy',g:'Unknown',v:null,t:3}, {n:'Kavaklƒ±dere Ancyra Kalecik Karasi',r:'Ankara, Turkey',c:'Turkey',g:'Kalecik Karasi',v:null,t:3}, {n:'Le Ginestre Chianti Classico',r:'Chianti Classico, Italy',c:'Italy',g:'Sangiovese',v:null,t:3}, {n:'Los Morros Pinot Noir',r:'Central Valley, Chile',c:'Chile',g:'Pinot Noir',v:null,t:3}, {n:'Protocolo Tinto',r:'Castilla-La Mancha, Spain',c:'Spain',g:'Tempranillo',v:null,t:3}, {n:'Quinta Las Cabras Carmen√®re',r:'Cachapoal Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:3}, {n:'Tarapac√° Gran Reserva Carmen√®re',r:'Maipo Valley, Chile',c:'Chile',g:'Carmen√®re',v:null,t:3}, {n:'Teutonic Bellpine Vineyards Pinot Noir',r:'Willamette Valley, United States',c:'United States',g:'Pinot Noir',v:null,t:3}, {n:'Veralda Ros√© Xtrian',r:'Istria, Croatia',c:'Croatia',g:'Unknown',v:null,t:3}];
let cellarWines=null,cellarFilter='all',cellarLoading=false;
async function loadCellar(){
if(cellarWines&&cellarWines.length>0)return;cellarLoading=true;render();
try{
const r=await fetch(SB_URL+'/rest/v1/wines?select=*&order=rating.desc,name.asc&limit=1000',{headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}});
if(r.ok){const d=await r.json();if(Array.isArray(d)&&d.length>0){cellarWines=d;cellarLoading=false;render();return}}
}catch(e){}
cellarWines=CW.map(w=>({name:w.n,region:w.r,country:w.c,grape:w.g,vintage:w.v,rating:w.t}));
cellarLoading=false;render()}
function cellarStats(){
if(!cellarWines)return{total:231,countries:12,avg:'4.2',grapes:{},regions:{},byCountry:{},byRating:{}};
const grapes={},regions={},byCountry={},byRating={},countries=new Set();
cellarWines.forEach(w=>{
if(w.grape){grapes[w.grape]=(grapes[w.grape]||0)+1}
if(w.region){regions[w.region]=(regions[w.region]||0)+1}
if(w.country){byCountry[w.country]=(byCountry[w.country]||0)+1;countries.add(w.country)}
const rk=String(w.rating);byRating[rk]=(byRating[rk]||0)+1;
});
const avg=(cellarWines.reduce((s,w)=>s+w.rating,0)/cellarWines.length).toFixed(1);
return{total:cellarWines.length,countries:countries.size,avg,grapes,regions,byCountry,byRating}}
const TASTE=`DINER PATTERN (what unites their 790 favorite venues across 31 countries):
1. SOUL over concept ‚Äî chef passion > design. Rintaro, Isolina, Taberna Antonio Sanchez
2. INGREDIENT-DRIVEN ‚Äî product is star. Bar Crudo, PPQ Dungeness, Parador La Huella
3. NEIGHBORHOOD-ROOTED ‚Äî locals eat here. Burma Superstar, Halu, La Carmencita
4. WINE AS COMPANION ‚Äî always part of the meal. Corks wine bar (38x), wineries (72 visits)
5. UNPRETENTIOUS QUALITY ‚Äî no dress code, serious food. El Che, Underdogs Tres
6. CULTURAL AUTHENTICITY ‚Äî teaches you about its cuisine. Rintaro, Isolina
7. FIRE AND SEA ‚Äî grilled, raw seafood, wood-fired
8. REGULARS' PLACE ‚Äî owner knows you after 3 visits
AVOIDS: tourist traps, chains, hotel restaurants, molecular gimmicks, Instagram-famous
NIGHTLIFE: neighborhood pubs (206x), craft cocktails (74x), dive bars (34x), natural wine bars (72x)
LOYALTY REFS: Burma Superstar (Burmese SF 39x), Corks (wine bar Medellin 38x), Rintaro (izakaya SF), Bar Crudo (raw bar SF), Parador La Huella (beach Uruguay), La Carmencita (vermouth Madrid)`;

let S={tab:'profile',city:'',loc:'',vibe:'all',loading:false,phase:'',results:null,error:'',loved:{},rejected:{},toast:'',
scanMode:null,scanPhotos:[],scanLoading:false,scanPhase:'',scanResults:null,scanError:''};
try{S.loved=JSON.parse(localStorage.getItem('h-loved')||'{}')}catch{}
try{S.rejected=JSON.parse(localStorage.getItem('h-rej')||'{}')}catch{}

async function loadFeedback(){
try{
const r=await fetch(SB_URL+'/rest/v1/venue_feedback?select=*&order=created_at.desc',{headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}});
if(r.ok){const rows=await r.json();if(Array.isArray(rows)){
S.loved={};S.rejected={};
rows.forEach(row=>{
const meta={city:row.city,cuisine:row.cuisine,price:row.price,score:row.score,spirit:row.spirit,hood:row.neighborhood,t:new Date(row.created_at).getTime(),_id:row.id};
if(row.feedback==='loved')S.loved[row.name]=meta;
else S.rejected[row.name]=meta;
});
localStorage.setItem('h-loved',JSON.stringify(S.loved));
localStorage.setItem('h-rej',JSON.stringify(S.rejected));
render();
}}
}catch(e){console.log('Feedback load fallback to localStorage',e)}}
loadFeedback();

async function fbUpsert(name,meta,type){
try{
// Delete any existing row for this name first
await fetch(SB_URL+'/rest/v1/venue_feedback?name=eq.'+encodeURIComponent(name),{method:'DELETE',headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}});
// Insert new
const row={name,city:meta.city||null,cuisine:meta.cuisine||null,price:meta.price||null,score:meta.score||null,spirit:meta.spirit||null,neighborhood:meta.hood||null,feedback:type};
const r=await fetch(SB_URL+'/rest/v1/venue_feedback',{method:'POST',headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(row)});
if(r.ok){const[saved]=await r.json();return saved}
}catch(e){console.log('Feedback save error',e)}return null}

async function fbDelete(name){
try{await fetch(SB_URL+'/rest/v1/venue_feedback?name=eq.'+encodeURIComponent(name),{method:'DELETE',headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}})}catch(e){}}


const BASE={venues:1340,countries:31,wines:231,avg:'4.2'};
const BASE_PP=[{f:'üá∫üá∏',n:'USA',c:265},{f:'üá™üá∏',n:'Spain',c:208},{f:'üá®üá¥',n:'Colombia',c:131},{f:'üáÆüáπ',n:'Italy',c:131},{f:'üá´üá∑',n:'France',c:63},{f:'üá≤üáΩ',n:'Mexico',c:60},{f:'üá¨üáß',n:'UK',c:51},{f:'üáØüáµ',n:'Japan',c:41},{f:'üáπüá≠',n:'Thailand',c:41},{f:'üáµüáπ',n:'Portugal',c:40}];
const CC={'Tokyo':'üáØüáµ Japan','Kyoto':'üáØüáµ Japan','Osaka':'üáØüáµ Japan','Lisbon':'üáµüáπ Portugal','Porto':'üáµüáπ Portugal','Buenos Aires':'üá¶üá∑ Argentina','Copenhagen':'üá©üá∞ Denmark','Barcelona':'üá™üá∏ Spain','Madrid':'üá™üá∏ Spain','El Retiro':'üá™üá∏ Spain','Sevilla':'üá™üá∏ Spain','CDMX':'üá≤üáΩ Mexico','Berlin':'üá©üá™ Germany','Munich':'üá©üá™ Germany','Paris':'üá´üá∑ France','Lyon':'üá´üá∑ France','Rome':'üáÆüáπ Italy','Milan':'üáÆüáπ Italy','Florence':'üáÆüáπ Italy','Naples':'üáÆüáπ Italy','London':'üá¨üáß UK','Lima':'üáµüá™ Peru','Montevideo':'üá∫üáæ Uruguay','Medell√≠n':'üá®üá¥ Colombia','Bogot√°':'üá®üá¥ Colombia','Cartagena':'üá®üá¥ Colombia','San Francisco':'üá∫üá∏ USA','New York':'üá∫üá∏ USA','Los Angeles':'üá∫üá∏ USA','Bangkok':'üáπüá≠ Thailand','Seoul':'üá∞üá∑ South Korea','Singapore':'üá∏üá¨ Singapore','Sydney':'üá¶üá∫ Australia','Amsterdam':'üá≥üá± Netherlands','Prague':'üá®üáø Czechia','Vienna':'üá¶üáπ Austria','Istanbul':'üáπüá∑ Turkey','Dublin':'üáÆüá™ Ireland','Stockholm':'üá∏üá™ Sweden','Athens':'üá¨üá∑ Greece','Split':'üá≠üá∑ Croatia'};
const VBC={
'USA':['Burma Superstar','Toronado','Umami Burger','China Live','Ariake','Halu','Rintaro','Bar Crudo','PPQ Dungeness Island','Bask','Rosamunde Sausage Grill','Estiatorio Milos','Keens Steakhouse','JG Melon'],
'Spain':['La Carmencita','Taberna Antonio S√°nchez','Castelados','El Chiringuito','ORIO Fuencarral','Bar Pelayo','Quispe','O Grelo','Casa Benigna','Barrutia'],
'Colombia':['Corks','Underdogs Tres','El Ch√©','Sakesan Sushi & Bistro','CCs Cocktails','37 Park','Alambique','Bipolar Brewing Co.','Casa M - Casa Libre','Baco Vino y Bistro'],
'Italy':['Cucina del Teatro','Alfredo alla Scrofa','Taverna Trilussa','Osteria dei Cappellari','Da Ganino Hosteria','Antica Porchetteria Granieri 1916','Pescheria Bianchi','Il Corallo'],
'France':['La Cigale','Chez Maman','Nina √† la Plage','Grain de Folie','Caf√© de la Loire','Cardamom'],
'Mexico':['Diente de Oro','Rosetta','El Mirador By Guaycura','Tori Tori Tem√≠stocles','Guzina Oaxaca','La Mezcaler√≠a','Siete Lunas'],
'UK':['Masala Zone Covent Garden','Seabird','The Spanish Butcher','Nell Gwynne Tavern','The Scotch Malt Whisky Society','Duncraig Castle'],
'Japan':['Butagumi','sake √ó oyster BAR Áü≥Ëä±','Atrevio','„ÅÑ„ÅÑ„Å® EAT È∫ªÂ∏ÉÂçÅÁï™','Pizzeria & Bar Nohga','NAGUY BAR Âá™'],
'Thailand':['The House by Ginger','Kiti Panit','Railay Beach Cafe','Reeve Beach Club Krabi','Ploen Rudee Night Market'],
'Turkey':['Zƒ±pkƒ±n','Tavanarasƒ±','Balƒ±k√ßƒ± Sabahattin','Lokma','Wood Karak√∂y','M√º≈üterek Meyhane'],
'Portugal':['Sol e Pesca','Cervejaria Ramiro','O Velho Eurico','Ginjinha Sem Rival','Associa√ß√£o Loucos e Sonhadores'],
'Brazil':['Nino Cucina','Due Cuochi Cucina','Casa da Feijoada','Santo Gr√£o','Raw the Burguer Bar','La Carioca en La Playa'],
'Germany':['Biergarten am Chinesischen Turm','Yum','Hofbr√§uhaus M√ºnchen','Im S√ºden','Cotidiano G√§rtnerplatz'],
'Netherlands':['In t Aepjen','Caf√© de Buurvrouw','Simonis aan de Haven','MR PORTER','tam tam'],
'Peru':['Isolina Taberna Peruana','Canta Rana','El Muelle','La Mar Cebicher√≠a','Siete'],
'Uruguay':['Parador La Huella','La Juana','Solera Vinos Y Tapas','La Susana','Narbona'],
'Indonesia':['Potato Head Folk','La Plancha','La Brisa','Caf√© del Mar Bali','Finns Beach Club'],
'S. Korea':['WUMOK','VUUR','Osteria Eobu','Zest','ÎπÖÎ∂ÄÏ¶à'],
'Singapore':['Pasta Bar','Claudine','Smalls','Lukes Oyster Bar','Tapas 24'],
'Croatia':['Oliva','Marvlvs Library Jazz Bar','Zinfandel','Restaurant diVino','Dalmatino'],
'Austria':['Bindaas','Finsterwirt','Gasthof Hinterbr√ºhl','Franziskanerstuben','Augustiner Stammhaus'],
'Ireland':['The Dame Tavern','O Donoghues','Tigh Neachtain','Ard Bia at Nimmos','Coffeewerk + Press'],
'Morocco':['El Morocco Club','El Tangerino','Restaurant L Oc√©an','Caf√© Baba'],
'Argentina':['Don Julio Parilla','El Preferido de Palermo','Choripaner√≠a','Eretz Cantina Israel√≠','Backroom Bar'],
'UAE':['Coya','Hakkasan','Tot√≥','Ilios'],
'Hungary':['Doblo Wine & Bar','Macesz Bistro','Mitico'],
'Denmark':['Gorms Pizza','The Moose','Wessels Kro'],
'Switzerland':['Ebrietas','Bonnie Prince','Restaurant Schipfe 16'],
'Greece':['Scorpios Mykonos','THEA Estiatorio Mykonos'],
'Belgium':['Toukoul','Delirium TapHouse','t Verschil'],
'Chile':['La Tasca de Altamar','La Mar','Kil√≥metro 0']
};
const FL={'USA':'üá∫üá∏','Spain':'üá™üá∏','Colombia':'üá®üá¥','Italy':'üáÆüáπ','France':'üá´üá∑','Mexico':'üá≤üáΩ','UK':'üá¨üáß','Japan':'üáØüáµ','Thailand':'üáπüá≠','Turkey':'üáπüá∑','Portugal':'üáµüáπ','Brazil':'üáßüá∑','Germany':'üá©üá™','Netherlands':'üá≥üá±','Peru':'üáµüá™','Uruguay':'üá∫üáæ','Indonesia':'üáÆüá©','S. Korea':'üá∞üá∑','Singapore':'üá∏üá¨','Croatia':'üá≠üá∑','Austria':'üá¶üáπ','Ireland':'üáÆüá™','Morocco':'üá≤üá¶','Argentina':'üá¶üá∑','UAE':'üá¶üá™','Hungary':'üá≠üá∫','Denmark':'üá©üá∞','Switzerland':'üá®üá≠','Greece':'üá¨üá∑','Belgium':'üáßüá™','Chile':'üá®üá±'};
const AV=[];Object.entries(VBC).forEach(([co,vs])=>vs.forEach(n=>{AV.push({n,co})}));
function shuf(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]]}return b}
let ppOpen=null;
const SV=shuf(AV);
function gDC(){return Object.keys(S.loved).length}
function gTV(){return BASE.venues+gDC()}
function gPP(){const m={};BASE_PP.forEach(p=>{m[p.n]={f:p.f,c:p.c}});Object.values(S.loved).forEach(v=>{if(typeof v==='object'&&v.city){const cc=CC[v.city];if(cc){const[flag,country]=cc.split(' ');if(!m[country])m[country]={f:flag,c:0};m[country].c++}}});const extra={'Turkey':{f:'üáπüá∑',c:37},'Brazil':{f:'üáßüá∑',c:36},'Germany':{f:'üá©üá™',c:35},'Netherlands':{f:'üá≥üá±',c:25},'Singapore':{f:'üá∏üá¨',c:22},'Uruguay':{f:'üá∫üáæ',c:22},'Indonesia':{f:'üáÆüá©',c:15},'S. Korea':{f:'üá∞üá∑',c:14},'Croatia':{f:'üá≠üá∑',c:14},'Austria':{f:'üá¶üáπ',c:14},'Argentina':{f:'üá¶üá∑',c:13},'Ireland':{f:'üáÆüá™',c:11},'Peru':{f:'üáµüá™',c:10},'Morocco':{f:'üá≤üá¶',c:9},'UAE':{f:'üá¶üá™',c:8},'Hungary':{f:'üá≠üá∫',c:5},'Switzerland':{f:'üá®üá≠',c:5},'Denmark':{f:'üá©üá∞',c:4},'Chile':{f:'üá®üá±',c:4},'Greece':{f:'üá¨üá∑',c:3},'Belgium':{f:'üáßüá™',c:3}};Object.entries(extra).forEach(([n,v])=>{if(!m[n])m[n]=v});return Object.entries(m).map(([n,v])=>({f:v.f,n,c:v.c})).sort((a,b)=>b.c-a.c)}
function gTC(){const s=new Set();gPP().forEach(p=>s.add(p.n));return s.size}
function sL(){localStorage.setItem('h-loved',JSON.stringify(S.loved))}
function sR(){localStorage.setItem('h-rej',JSON.stringify(S.rejected))}
function toast(m){S.toast=m;render();setTimeout(()=>{S.toast='';render()},2000)}
function tLove(n,meta){
if(S.loved[n]){delete S.loved[n];fbDelete(n);toast('Removed');sL();render();return}
S.loved[n]={city:S.city,t:Date.now(),...(meta||{})};fbUpsert(n,S.loved[n],'loved');
if(S.rejected[n]){delete S.rejected[n];sR()}
sL();
// Animate heart on existing card before re-render
const cards=document.querySelectorAll('.rc');
cards.forEach(c=>{if(c.querySelector('.rc-nm')?.textContent===n){c.classList.add('lc');const btn=c.querySelector('.ab:last-of-type');if(btn)btn.classList.add('lo')}});
toast('‚ô• Saved');
setTimeout(()=>render(),350)}
function tRej(n,meta){
if(S.rejected[n]){delete S.rejected[n];fbDelete(n);toast('Restored');sR();render();return}
S.rejected[n]={city:S.city,t:Date.now(),...(meta||{})};fbUpsert(n,S.rejected[n],'rejected');
if(S.loved[n]){delete S.loved[n];sL()}
sR();
// Animate dismiss on existing card, then re-render
const cards=document.querySelectorAll('.rc');
cards.forEach(c=>{if(c.querySelector('.rc-nm')?.textContent===n)c.classList.add('xc')});
toast('‚úï Dismissed');
setTimeout(()=>render(),500)}
async function clr(){S.loved={};S.rejected={};localStorage.removeItem('h-loved');localStorage.removeItem('h-rej');
try{await fetch(SB_URL+'/rest/v1/venue_feedback',{method:'DELETE',headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'},body:'{}'})}catch{}
toast('Reset');render()}
function tasteDNA(){
const loved=Object.values(S.loved).filter(v=>typeof v==='object'&&v.cuisine);
const rejected=Object.values(S.rejected).filter(v=>typeof v==='object'&&v.cuisine);
const cuisines={},vibes={},prices={};
loved.forEach(v=>{
if(v.cuisine){v.cuisine.split(/[,\/&]+/).forEach(c=>{c=c.trim();if(c)cuisines[c]=(cuisines[c]||0)+1})}
if(v.spirit){const words=v.spirit.toLowerCase();
['soul','fire','grill','seafood','raw','wood','neighborhood','local','wine','authentic','rustic','casual','craft','intimate','traditional','family','market','seasonal'].forEach(w=>{if(words.includes(w))vibes[w]=(vibes[w]||0)+1})}
if(v.price)prices[v.price]=(prices[v.price]||0)+1;
});
const rejCuisines={};
rejected.forEach(v=>{if(v.cuisine){v.cuisine.split(/[,\/&]+/).forEach(c=>{c=c.trim();if(c)rejCuisines[c]=(rejCuisines[c]||0)+1})}});
return{cuisines,vibes,prices,rejCuisines,lovedCount:loved.length,rejCount:rejected.length}}
function fb(){
const l=Object.entries(S.loved).filter(([n,v])=>typeof v==='object');
const r=Object.entries(S.rejected).filter(([n,v])=>typeof v==='object');
const dna=tasteDNA();
let c='';
if(l.length){
c+='\n\nUSER-CONFIRMED LOVES ('+l.length+'):\n';
l.forEach(([n,v])=>{c+='  ‚ô• '+n+(v.cuisine?' ['+v.cuisine+']':'')+(v.spirit?' ‚Äî '+v.spirit:'')+'\n'});
const topCuisines=Object.entries(dna.cuisines).sort((a,b)=>b[1]-a[1]).slice(0,5);
if(topCuisines.length)c+='\nLEARNED CUISINE PREFERENCES: '+topCuisines.map(([k,v])=>k+' ('+v+'x)').join(', ');
const topVibes=Object.entries(dna.vibes).sort((a,b)=>b[1]-a[1]).slice(0,6);
if(topVibes.length)c+='\nLEARNED VIBE PREFERENCES: '+topVibes.map(([k,v])=>k+' ('+v+'x)').join(', ');
}
if(r.length){
c+='\n\nUSER-REJECTED (AVOID '+r.length+'):\n';
r.forEach(([n,v])=>{c+='  ‚úï '+n+(v.cuisine?' ['+v.cuisine+']':'')+'\n'});
const topRej=Object.entries(dna.rejCuisines).sort((a,b)=>b[1]-a[1]).slice(0,5);
if(topRej.length)c+='\nAVOID THESE STYLES: '+topRej.map(([k,v])=>k+' ('+v+'x)').join(', ');
}
return c}
function isLoved(n){return !!S.loved[n]}
async function callAPI(sys,usr,mdl,srch){const b={system:sys,messages:[{role:'user',content:usr}],max_tokens:3000};if(mdl)b.model=mdl;if(srch)b.tools=[{type:'web_search_20250305',name:'web_search'}];const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});return await r.json()}
function txt(d){return(d.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('\n')}
function pj(t){const c=t.replace(/```json|```/g,'').trim();const s=c.indexOf('{'),e=c.lastIndexOf('}');return s>=0?JSON.parse(c.substring(s,e+1)):null}
const VM={all:'restaurants, bars, and wine spots',restaurant:'restaurants and cafes only',bar:'bars, pubs, cocktail bars, dive bars',wine:'wine bars, natural wine spots, enotecas, vinotecas'};
async function go(){if(!S.city.trim()||S.loading)return;S.loading=true;S.error='';S.results=null;render();const loc=S.loc.trim()?`near ${S.loc.trim()} (within 30 min walking distance)`:'';try{S.phase='Searching for real places...';render();const sr=await callAPI('You are a restaurant researcher. Search the web and return only REAL, currently operating places. Never invent names.',`Search for the best ${VM[S.vibe]} in ${S.city}${loc?' '+loc:''}. Quality-focused, local favorites, hidden gems. Search 3-4 different queries. List 12-18 real places: name, neighborhood, cuisine, price range.`,'claude-sonnet-4-20250514',true);const found=txt(sr);if(!found||found.length<20){S.error="Couldn't find places.";S.loading=false;render();return}S.phase='Matching to your palate...';render();const wc=S.loc.trim()?`Diner is near: ${S.loc.trim()}. Include walking time.`:'Include neighborhood.';const sc=await callAPI(`You score places against a diner's taste pattern.\n\n${TASTE}${fb()}\n\nRespond ONLY with valid JSON:\n{"city_vibe":"2-3 sentences","restaurants":[{"name":"exact name","neighborhood":"area","cuisine":"type","price":"$$","walk":"time or area","spirit":"which loyalty venue this echoes, 1 sentence","score":8,"q":"name city for maps"}]}\nSort by score desc.`,`City: ${S.city}\n${wc}\nCategory: ${VM[S.vibe]}\n\nPlaces found:\n${found}\n\nScore each. Only include places from the search results.`,'claude-sonnet-4-20250514',false);const p=pj(txt(sc));if(p?.restaurants?.length)S.results=p;else S.error="Couldn't score. Try again."}catch(e){S.error='Error: '+e.message}S.loading=false;S.phase='';render()}
function sc(s){return s>=9?'s9':s>=7?'s7':s>=5?'s5':'sl'}
function maps(r){return`https://www.google.com/maps/search/${encodeURIComponent(r.q||r.name+' '+S.city)}`}
function esc(n){return n.replace(/'/g,"\\'").replace(/"/g,'&quot;')}
function switchTab(t){S.tab=t;window.scrollTo(0,0);render()}

function scanReset(){S.scanMode=null;S.scanPhotos=[];S.scanLoading=false;S.scanPhase='';S.scanResults=null;S.scanError='';render()}
function scanAddPhoto(input){
Array.from(input.files).forEach(f=>{const r=new FileReader();r.onload=e=>{S.scanPhotos.push(e.target.result);render()};r.readAsDataURL(f)});input.value=''}
function scanRemove(i){S.scanPhotos.splice(i,1);render()}
function resizeImg(dataUrl,maxW=1200){
return new Promise(resolve=>{
const img=new Image();
img.onload=()=>{
let w=img.width,h=img.height;
if(w<=maxW){resolve(dataUrl);return}
const r=maxW/w;w=maxW;h=Math.round(h*r);
const c=document.createElement('canvas');c.width=w;c.height=h;
c.getContext('2d').drawImage(img,0,0,w,h);
resolve(c.toDataURL('image/jpeg',0.85));
};img.onerror=()=>resolve(dataUrl);img.src=dataUrl;
})}
async function callScan(messages,max_tokens,system){
const b={messages,max_tokens:max_tokens||2000};
if(system)b.system=system;
const r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
return r.json()}
async function scanMenu(){
if(!S.scanPhotos.length||S.scanLoading)return;
S.scanLoading=true;S.scanError='';S.scanResults=null;S.scanPhase='Reading menu...';render();
try{
const resized=await Promise.all(S.scanPhotos.map(p=>resizeImg(p)));
const c=[];
resized.forEach(img=>{c.push({type:'image',source:{type:'base64',media_type:img.split(';')[0].split(':')[1],data:img.split(',')[1]}})});
const pair=document.getElementById('scan-pair')?.value||'';
c.push({type:'text',text:'Extract ALL wines from '+(S.scanPhotos.length>1?'these photos':'this photo')+'. For each wine return name and price. Return ONLY JSON array: [{"name":"wine name","price":45}]. Use null if no price. No explanation.'});
const d1=await callScan([{role:'user',content:c}],2000);
if(d1.error){S.scanError='API error: '+JSON.stringify(d1.error);S.scanLoading=false;render();return}
let mw=[];try{mw=JSON.parse((d1.content?.map(x=>x.text||'').join('')||'[]').replace(/```json|```/g,'').trim())}catch(e){S.scanError='Could not read menu';S.scanLoading=false;render();return}
if(typeof mw[0]==='string')mw=mw.map(n=>({name:n,price:null}));
if(!mw?.length){S.scanError='No wines found on menu';S.scanLoading=false;render();return}
S.scanPhase='Your sommelier is thinking...';render();
const names=mw.map(w=>w.name);
const cw=cellarWines||CW.map(w=>({name:w.n,region:w.r,country:w.c,grape:w.g,vintage:w.v,rating:w.t}));
const gm={};cw.forEach(w=>{if(w.grape&&w.grape!=='Unknown')gm[w.grape]=(gm[w.grape]||0)+1});
const topGr=Object.entries(gm).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([g,n])=>g+' ('+n+')').join(', ');
const cwAvg=cw.length?(cw.reduce((s,w)=>s+w.rating,0)/cw.length).toFixed(1):'4.2';
const somPrompt='You score wine menu items for a wine enthusiast. '+cw.length+' wines rated, avg '+cwAvg+'. Favorite grapes: '+topGr+'. Prefers Spanish reds (Rioja, Ribera del Duero), Southern Italian, Uruguayan Tannat, and Italian whites.'+(pair?' Eating: '+pair:'')+'\n\nMenu wines:\n'+names.map((n,i)=>(i+1)+'. '+n).join('\n')+'\n\nScore each 1-10 on how much this diner would enjoy it. Return ONLY JSON: {"wines":[{"name":"exact menu name","score":8,"region":"if known","grape":"if known","note":"1 sentence why this score"'+(pair?',"pairing":"food pairing note"':'')+'}]}';
const d2=await callScan([{role:'user',content:somPrompt}],3000);
if(d2.error){S.scanError='Scoring error';S.scanLoading=false;render();return}
const t2=(d2.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
const c2=t2.replace(/```json|```/g,'').trim();const si=c2.indexOf('{'),ei=c2.lastIndexOf('}');
const parsed=JSON.parse(c2.substring(si,ei+1));
if(parsed?.wines?.length){S.scanResults={wines:parsed.wines.sort((a,b)=>b.score-a.score),pairing:pair}}
else S.scanError='Could not analyze wines'
}catch(e){S.scanError='Error: '+e.message}
S.scanLoading=false;S.scanPhase='';render()}

async function scanBottle(){
if(!S.scanPhotos.length||S.scanLoading)return;
S.scanLoading=true;S.scanError='';S.scanResults=null;S.scanPhase='Reading label...';render();
try{
const resized=await resizeImg(S.scanPhotos[0]);
const content=[{type:'image',source:{type:'base64',media_type:resized.split(';')[0].split(':')[1],data:resized.split(',')[1]}},
{type:'text',text:'Read wine label. ONLY JSON: {"name":"wine","winery":"producer","region":"region","country":"country","grape":"grape or null","vintage":2020,"notes":"1-2 sentence tasting description"}. Nulls for unknowns.'}];
const d=await callScan([{role:'user',content}],500);
if(d.error){S.scanError='API error';S.scanLoading=false;render();return}
const t=(d.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
const c=t.replace(/```json|```/g,'').trim();const si=c.indexOf('{'),ei=c.lastIndexOf('}');
S.scanResults={bottle:JSON.parse(c.substring(si,ei+1))}
}catch(e){S.scanError='Error: '+e.message}
S.scanLoading=false;S.scanPhase='';render()}

async function saveBottle(){
if(!S.scanResults?.bottle)return;
const b=S.scanResults.bottle;
const wine={name:b.name,region:b.region||null,country:b.country||null,grape:b.grape||null,vintage:b.vintage||null,rating:S.scanResults.bottleRating||4,reorder:S.scanResults.bottleReorder||null,source:'bottle_scan'};
try{
const r=await fetch(SB_URL+'/rest/v1/wines',{method:'POST',headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(wine)});
if(r.ok){const[saved]=await r.json();if(cellarWines){cellarWines.unshift(saved);cellarWines.sort((a,b2)=>b2.rating-a.rating)}}
}catch(e){if(cellarWines){cellarWines.unshift(wine);cellarWines.sort((a,b2)=>b2.rating-a.rating)}}
S.toast='‚úì '+b.name+' saved';scanReset()}

function render(){
const lc=Object.keys(S.loved).length,rc=Object.keys(S.rejected).length;let h='';
if(S.toast)h+=`<div class="toast">${S.toast}</div>`;
const tabs=[{id:'profile',ic:'üë§',l:'Profile'},{id:'discover',ic:'üîç',l:'Discover'},{id:'scan',ic:'üì∑',l:'Scan'},{id:'cellar',ic:'üç∑',l:'Cellar'}];
h+=`<nav class="nav">`;tabs.forEach(t=>{h+=`<button class="ni${S.tab===t.id?' on':''}" onclick="switchTab('${t.id}')"><span class="ni-ic">${t.ic}</span>${t.l}</button>`});h+=`</nav>`;

if(S.tab==='profile'){
if(!cellarWines&&!cellarLoading)loadCellar();
h+=`<div class="hero"><h1>Hedonicum</h1><div class="sub">Taste Intelligence</div></div>`;
const wn=cellarWines?cellarWines.length:231;
const wcn=cellarWines?new Set(cellarWines.map(w=>w.country).filter(Boolean)).size:12;
const wavg=cellarWines&&cellarWines.length?(cellarWines.reduce((s,w)=>s+w.rating,0)/cellarWines.length).toFixed(1):'4.2';
const wGrapes=cellarWines?new Set(cellarWines.map(w=>w.grape).filter(g=>g&&g!=='Unknown')).size:40;
const vn=gTV(),vc=gTC();
// H-Score: 0-100
const hs=Math.min(100,Math.round(
  Math.min(wn/3,25)+
  Math.min(vn/80,25)+
  Math.min(vc/2,15)+
  Math.min(wGrapes/2,10)+
  Math.min(Object.keys(S.loved).length/3,10)+
  (parseFloat(wavg)>=4?5:parseFloat(wavg)>=3.5?3:1)+
  Math.min((cellarWines?cellarWines.filter(w=>w.rating>=5):CW.filter(w=>w.t>=5)).length/2,10)
));
const hStars=hs>=80?5:hs>=60?4:hs>=40?3:hs>=20?2:1;
const hTier=hStars===5?'Epicurean':hStars===4?'Tastemaker':hStars===3?'Refined':hStars===2?'Adventurous':'Curious';
const hStarStr='‚òÖ'.repeat(hStars)+'‚òÜ'.repeat(5-hStars);
h+=`<div class="identity">`;
h+=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">`;
h+=`<div><div class="id-h"><a href="https://x.com/holdmybirra" target="_blank" style="color:inherit;text-decoration:none">@Holdmybirra</a></div></div>`;
h+=`<div style="text-align:right"><div style="font-size:20px;letter-spacing:2px;color:var(--gold)">${hStarStr}</div><div style="display:flex;align-items:baseline;justify-content:flex-end;gap:6px"><span style="font-size:22px;font-weight:800;color:var(--gold);line-height:1">${hs}</span><span style="font-size:10px;letter-spacing:1.5px;color:var(--gold);font-weight:600;text-transform:uppercase">${hTier}</span></div></div>`;
h+=`</div>`;
h+=`<div class="id-bio">`;
h+=`<div style="color:var(--text-d);font-size:12px;line-height:1.6;margin-bottom:8px">H-Score earned through <span style="color:var(--gold);font-weight:700">${wn}</span> wines ¬∑ <span style="color:var(--gold);font-weight:700">${vn}</span> venues ¬∑ <span style="color:var(--gold);font-weight:700">${vc}</span> countries</div>`;
h+=`<div style="color:var(--text-m);font-size:13px;line-height:1.5;margin-bottom:8px">Tempranillo loyalist. Neighborhood over hype. Fire &amp; sea over foam &amp; tweezers.</div>`;
h+=`</div>`;
h+=`</div>`;
h+=`<div class="sec"><div class="sec-h">Taste DNA</div>`;
const dna=tasteDNA();
const basePillars=['Soul over concept','Fire & sea','Neighborhood roots','Wine companion','Ingredient-driven','Regulars\' place'];
if(dna.lovedCount>=3){
const topC=Object.entries(dna.cuisines).sort((a,b)=>b[1]-a[1]).slice(0,4);
const topV=Object.entries(dna.vibes).sort((a,b)=>b[1]-a[1]).slice(0,4);
const rejC=Object.entries(dna.rejCuisines).sort((a,b)=>b[1]-a[1]).slice(0,3);
h+=`<div class="dna">`;
if(topC.length){h+=`<div class="dp"><b>Craves:</b> ${topC.map(([k,v])=>k+' <span style="color:var(--gold)">('+v+')</span>').join(', ')}</div>`}
if(topV.length){h+=`<div class="dp"><b>Vibes:</b> ${topV.map(([k,v])=>k+' <span style="color:var(--gold)">('+v+')</span>').join(', ')}</div>`}
basePillars.forEach(d=>{h+=`<div class="dp">${d}</div>`});
if(rejC.length){h+=`<div class="dp" style="opacity:.5"><b>Avoids:</b> ${rejC.map(([k])=>k).join(', ')}</div>`}
h+=`</div>`;
h+=`<div style="font-size:11px;color:var(--text-d);margin-top:6px">${dna.lovedCount} ‚ô• ¬∑ ${dna.rejCount} ‚úï ‚Äî your taste evolves with every choice</div>`;
}else{
h+=`<div class="dna">`;basePillars.forEach(d=>{h+=`<div class="dp">${d}</div>`});h+=`</div>`;
h+=`<div style="font-size:11px;color:var(--text-d);margin-top:6px">‚ô• or ‚úï venues in Discover to build your taste profile</div>`;
}
h+=`</div>`;
h+=`<div class="sec"><div class="sec-h">Wine Palate</div>`;
const wpWines=cellarWines||(CW?CW.map(w=>({name:w.n,region:w.r,country:w.c,grape:w.g,vintage:w.v,rating:w.t})):null);
if(wpWines&&wpWines.length>0){
const wg={},wc={},wr={};
wpWines.forEach(w=>{if(w.grape&&w.grape!=='Unknown'){wg[w.grape]=(wg[w.grape]||0)+1}if(w.country){wc[w.country]=(wc[w.country]||0)+1}if(w.region){wr[w.region]=(wr[w.region]||0)+1}});
const topG=Object.entries(wg).sort((a,b)=>b[1]-a[1]).slice(0,5);
const topC=Object.entries(wc).sort((a,b)=>b[1]-a[1]).slice(0,4);
const fives=wpWines.filter(w=>w.rating>=5).length;
const avg=(wpWines.reduce((s,w)=>s+w.rating,0)/wpWines.length).toFixed(1);
h+=`<div style="margin-bottom:8px">`;
topG.forEach(([g,n])=>{h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px"><span style="color:var(--text-m)">${g}</span><span style="color:var(--gold);font-weight:600;font-size:12px">${n}</span></div>`});
h+=`</div>`;
h+=`<div style="font-size:12px;color:var(--text-d)">${wpWines.length} wines ¬∑ ${fives} perfect scores ¬∑ ${avg} avg ¬∑ ${Object.keys(wc).length} countries</div>`;
}else{
h+=`<div style="font-size:12px;color:var(--text-d);padding:8px 0">Scan bottles to build your wine palate</div>`;
}
h+=`</div>`;
h+=`<div class="sec"><div class="sec-h">Passport ¬∑ ${gTC()} countries</div>`;
const pp=gPP();
pp.forEach(x=>{const isOpen=ppOpen===x.n;const vs=VBC[x.n]||[];
h+=`<div class="cr" onclick="ppOpen=ppOpen==='${x.n}'?null:'${x.n}';render()" style="margin-bottom:${isOpen?'0':'6'}px"><span class="cf">${x.f}</span><span class="cn">${x.n}</span><span class="cr-arr${isOpen?' op':''}">‚ñ∏</span><span class="cc">${x.c}</span></div>`;
h+=`<div class="cr-exp${isOpen?' open':''}">`;
if(isOpen&&vs.length){vs.forEach(v=>{const mq=encodeURIComponent(v+' '+x.n);h+=`<a href="https://www.google.com/maps/search/${mq}" target="_blank" class="cr-v" style="text-decoration:none;color:inherit"><span class="cv-n">${v}</span><span class="cv-c" style="color:var(--gold);font-size:10px">‚Üó</span></a>`})}
h+=`</div>`});
h+=`</div>`;

h+=`<div class="sec pb20"><div class="sec-h">Where is @Holdmybirra eating</div>`;
SV.slice(0,6).forEach((v,i)=>{const mq=encodeURIComponent(v.n+' '+v.co);h+=`<a href="https://www.google.com/maps/search/${mq}" target="_blank" class="feed-card" style="text-decoration:none;color:inherit;animation-delay:${i*.06}s"><div class="fc-info"><div class="fc-name">${v.n}</div><div class="fc-meta">${v.co}</div></div><span style="color:var(--gold);font-size:11px;flex-shrink:0">‚Üó</span></a>`});h+=`</div>`;
}

if(S.tab==='discover'){
h+=`<div class="disc"><div class="disc-h"><h2>Discover</h2><p>Your palate, any city</p></div>`;
h+=`<div class="pow"><div class="pow-av">üç∑</div><div class="pow-t">Powered by <a href="https://x.com/holdmybirra" target="_blank" style="color:var(--gold);text-decoration:none"><b>@Holdmybirra's palate</b></a> ‚Äî ${gTV()} venues, ${gTC()} countries</div></div>`;
h+=`<input class="im" id="ci" value="${S.city}" placeholder="Where are you going?"><input class="is" id="li" value="${S.loc}" placeholder="Staying near? (hotel, neighborhood)">`;
h+=`<div class="fr">`;[{id:'all',l:'All'},{id:'restaurant',l:'Eat'},{id:'bar',l:'Drink'},{id:'wine',l:'Wine'}].forEach(v=>{h+=`<button class="fb${S.vibe===v.id?' on':''}" onclick="S.vibe='${v.id}';render()">${v.l}</button>`});
h+=`</div><button class="go" onclick="go()" ${S.loading?'disabled':''}>${S.loading?'¬∑¬∑¬∑':'Discover'}</button>`;
if((lc>0||rc>0)&&!S.loading){h+=`<div class="tbar"><div class="tbar-s">`;if(lc>0)h+=`<span class="lv">‚ô• ${lc}</span>`;if(lc>0&&rc>0)h+=' ¬∑ ';if(rc>0)h+=`<span class="rj">‚úï ${rc}</span>`;h+=`<span style="color:var(--text-l);margin-left:6px">shaping taste</span></div><button class="tbar-r" onclick="clr()">Reset</button></div>`}
if(S.loading){h+=`<div class="ld"><div class="ld-t">${S.phase}</div>`;if(S.loc)h+=`<div class="ld-s">Near ${S.loc}</div>`;h+=`</div>`}
if(S.error)h+=`<div class="err">${S.error}</div>`;
if(S.results){window._rm=[];h+=`<div class="cv"><p>${S.results.city_vibe}</p></div>`;S.results.restaurants.forEach((r,i)=>{const isL=isLoved(r.name),isR=S.rejected[r.name],en=esc(r.name);window._rm[i]={cuisine:r.cuisine,price:r.price,score:r.score,spirit:r.spirit,hood:r.neighborhood};h+=`<div class="rc${isL?' lc':''}${isR?' xc':''}" style="animation:fadeUp .35s ease-out ${i*.04}s both"><div class="rc-top"><div class="rc-i"><div class="rc-nr"><a href="${maps(r)}" target="_blank" class="rc-nm">${r.name}</a><span class="rc-cu">${r.cuisine}</span>`;if(r.price)h+=`<span class="rc-pr">${r.price}</span>`;h+=`</div><div class="rc-loc">${r.neighborhood}${r.walk?`<span style="color:var(--text-d);margin-left:5px">¬∑ ${r.walk}</span>`:''}</div></div><div class="rc-act"><button class="ab${isR?' xo':''}" onclick="tRej('${en}',window._rm[${i}])">‚úï</button><div class="rc-sc"><div class="sn ${sc(r.score)}">${r.score}</div></div><button class="ab${isL?' lo':''}" onclick="tLove('${en}',window._rm[${i}])">‚ô•</button></div></div><p class="rc-sp">${r.spirit}</p><a href="${maps(r)}" target="_blank" class="rc-mp">‚Üí Maps</a></div>`});h+=`<div class="rf">Web-verified ¬∑ Pattern-matched ¬∑ ‚ô• ‚úï train your taste</div>`}
if(!S.loading&&!S.results&&!S.error){h+=`<div class="es"><p>Not where you've been.<br>Where you should go.</p><div class="cp">`;['Tokyo','Lisbon','Buenos Aires','Copenhagen','El Retiro','Barcelona','CDMX','Berlin'].forEach(c=>{h+=`<button class="cpl" onclick="S.city='${c}';render();document.getElementById('ci').value='${c}'">${c}</button>`});h+=`</div></div>`}
h+=`</div>`}

if(S.tab==='scan'){
h+=`<div class="scan"><h2>Scan</h2><p class="sh-p">AI-powered menu & wine intelligence</p>`;
if(!S.scanMode&&!S.scanLoading&&!S.scanResults){
h+=`<button class="scan-cta" onclick="S.scanMode='menu';render()"><div class="si">üì∑</div><h3>Scan Wine Menu</h3><p>Photograph the list ¬∑ get picks matched to your palate</p></button>`;
h+=`<div class="scan-alt" onclick="S.scanMode='bottle';render()"><div class="sa-i">üçæ</div><div><h3>Scan a Bottle</h3><p>Photograph label ¬∑ identify &amp; learn about any wine</p></div></div>`;
}
if(S.scanMode==='menu'&&!S.scanLoading&&!S.scanResults){
h+=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:11px;color:var(--text-d);letter-spacing:1px;text-transform:uppercase">Scan Wine Menu</span></div>`;
h+=`<input type="file" id="scan-file" accept="image/*" capture="environment" style="display:none" onchange="scanAddPhoto(this)">`;
if(S.scanPhotos.length){
h+=`<div class="scan-photos">`;S.scanPhotos.forEach((p,i)=>{h+=`<div class="scan-thumb-wrap"><img class="scan-thumb" src="${p}"><button class="scan-thumb-x" onclick="scanRemove(${i})">‚úï</button></div>`});h+=`</div>`;
h+=`<label class="scan-add-more" onclick="document.getElementById('scan-file').click()">+ Add page</label>`;
h+=`<input class="is" id="scan-pair" placeholder="What are you eating? (optional)">`;
h+=`<button class="go" onclick="scanMenu()">Analyze ${S.scanPhotos.length} ${S.scanPhotos.length===1?'Photo':'Photos'}</button>`;
}else{
h+=`<button class="scan-cta" onclick="document.getElementById('scan-file').click()"><div class="si">üì∑</div><h3>Take Photo of Wine Menu</h3><p>Multiple pages supported</p></button>`;
}
h+=`<div style="text-align:center;margin-top:12px"><button class="tbar-r" onclick="scanReset()">‚Üê Back</button></div>`;
}
if(S.scanMode==='bottle'&&!S.scanLoading&&!S.scanResults){
h+=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:11px;color:var(--text-d);letter-spacing:1px;text-transform:uppercase">Scan Bottle Label</span></div>`;
h+=`<input type="file" id="scan-file" accept="image/*" capture="environment" style="display:none" onchange="scanAddPhoto(this)">`;
if(S.scanPhotos.length){
h+=`<div class="scan-photos"><div class="scan-thumb-wrap"><img class="scan-thumb" src="${S.scanPhotos[0]}" style="width:120px;height:160px"><button class="scan-thumb-x" onclick="scanRemove(0)">‚úï</button></div></div>`;
h+=`<button class="go" onclick="scanBottle()">Identify Wine</button>`;
}else{
h+=`<button class="scan-cta" onclick="document.getElementById('scan-file').click()"><div class="si">üçæ</div><h3>Photograph the Label</h3><p>Get wine details instantly</p></button>`;
}
h+=`<div style="text-align:center;margin-top:12px"><button class="tbar-r" onclick="scanReset()">‚Üê Back</button></div>`;
}
if(S.scanLoading){h+=`<div class="ld"><div class="ld-t">${S.scanPhase}</div></div>`}
if(S.scanError){h+=`<div class="err">${S.scanError}</div><div style="text-align:center;margin-top:12px"><button class="tbar-r" onclick="scanReset()">Try again</button></div>`}
if(S.scanResults?.wines){
const w=S.scanResults.wines;const pair=S.scanResults.pairing;
h+=`<div style="text-align:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600">${w.length} wines found</span>`;
if(pair)h+=`<div style="font-size:11px;color:var(--text-d);margin-top:4px">Pairing with: <span style="color:var(--gold)">${pair}</span></div>`;
h+=`</div>`;
w.forEach((wine,i)=>{h+=`<div class="scan-wine" style="animation-delay:${i*.04}s"><div class="sw-top"><div><div class="sw-name">${wine.name}</div><div class="sw-meta">${wine.region||''}${wine.grape?' ¬∑ '+wine.grape:''}</div></div><div class="sw-score ${wine.score>=9?'s9':wine.score>=7?'s7':wine.score>=5?'s5':'sl'}">${wine.score}</div></div>`;
if(wine.note)h+=`<p class="sw-note">${wine.note}</p>`;
if(wine.pairing)h+=`<p class="sw-pair">üçΩ ${wine.pairing}</p>`;
h+=`</div>`});
h+=`<div style="text-align:center;margin-top:16px"><button class="go" style="background:transparent;color:var(--gold);border:1px solid var(--gold-border)" onclick="scanReset()">üì∑ Scan Another Menu</button></div>`;
}
if(S.scanResults?.bottle){
const b=S.scanResults.bottle;
if(!S.scanResults.bottleRating){
h+=`<div class="scan-bottle-card"><h3>${b.name}</h3>`;
if(b.winery)h+=`<div class="sb-winery">${b.winery}</div>`;
h+=`<div class="sb-detail">`;
if(b.region)h+=`üìç ${b.region}${b.country?', '+b.country:''}`;
if(b.grape)h+=`<br>üçá ${b.grape}`;
if(b.vintage)h+=`<br>üìÖ ${b.vintage}`;
h+=`</div>`;
if(b.notes)h+=`<p class="sb-notes">"${b.notes}"</p>`;
h+=`<div style="margin-top:16px"><div style="font-size:12px;color:var(--text-d);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Rate it</div>`;
h+=`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:16px">`;
[1,2,3,3.5,4,4.5,5].forEach(r=>{h+=`<button onclick="S.scanResults.bottleRating=${r};render()" style="width:40px;height:40px;border-radius:50%;border:1px solid var(--gold-border);background:transparent;color:var(--gold);font-size:13px;font-weight:700;cursor:pointer">${r}</button>`});
h+=`</div>`;
h+=`<div style="font-size:12px;color:var(--text-d);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Reorder?</div>`;
h+=`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:16px">`;
['yes','maybe','no'].forEach(r=>{h+=`<button onclick="S.scanResults.bottleReorder='${r}';S.scanResults.bottleRating=S.scanResults.bottleRating||4;render()" style="padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-m);font-size:13px;cursor:pointer">${r==='yes'?'‚úì Yes':r==='no'?'‚úó No':'~ Maybe'}</button>`});
h+=`</div></div>`;
h+=`<div style="text-align:center;margin-top:12px"><button class="tbar-r" onclick="scanReset()">Cancel</button></div>`;
}else{
const rt=S.scanResults.bottleRating;
const re=S.scanResults.bottleReorder||null;
h+=`<div class="scan-bottle-card"><h3>${b.name}</h3>`;
if(b.winery)h+=`<div class="sb-winery">${b.winery}</div>`;
h+=`<div class="sb-detail">`;
if(b.region)h+=`üìç ${b.region}${b.country?', '+b.country:''}`;
if(b.grape)h+=`<br>üçá ${b.grape}`;
h+=`<br>‚≠ê ${rt} ${re?'¬∑ '+(re==='yes'?'‚úì Reorder':re==='no'?'‚úó Skip':'~ Maybe'):''}`;
h+=`</div></div>`;
h+=`<button class="go" onclick="saveBottle()">Save to Cellar</button>`;
h+=`<div style="text-align:center;margin-top:12px"><button class="tbar-r" onclick="scanReset()">Cancel</button></div>`;
}
h+=`</div>`}
h+=`</div>`}

if(S.tab==='cellar'){
if(!cellarWines&&!cellarLoading)loadCellar();
const cs=cellarStats();
h+=`<div class="cel"><h2>Cellar</h2><p class="ch-p">${cs.total} wines ¬∑ ${cs.countries} countries ¬∑ avg ${cs.avg}</p><div class="cel-f">`;
['all','regions','grapes','insights'].forEach(f=>{h+=`<button class="cft${cellarFilter===f?' on':''}" onclick="cellarFilter='${f}';render()">${f[0].toUpperCase()+f.slice(1)}</button>`});
h+=`</div>`;
if(cellarLoading){h+=`<div class="ld"><div class="ld-t">Loading cellar...</div></div>`}
else if(cellarWines){
if(cellarFilter==='all'){
cellarWines.forEach((w,i)=>{if(i>50)return;h+=`<div class="wr" style="animation-delay:${Math.min(i*.03,.5)}s"><div class="wr-i"><div class="wr-n">${w.name}</div><div class="wr-m">${w.region||''}${w.grape?' ¬∑ '+w.grape:''}</div></div><div style="text-align:right"><div class="ws ${w.rating>=5?'w5':'w4'}">${w.rating}</div>${w.rating>=5?'<div class="wt">‚òÖ TOP</div>':''}</div></div>`});
if(cellarWines.length>50)h+=`<div style="text-align:center;padding:12px;color:var(--text-d);font-size:12px">Showing top 50 of ${cellarWines.length}</div>`;
}
if(cellarFilter==='regions'){
const sorted=Object.entries(cs.regions).sort((a,b)=>b[1]-a[1]);
sorted.forEach((r,i)=>{h+=`<div class="wr" style="animation-delay:${Math.min(i*.03,.4)}s"><div class="wr-i"><div class="wr-n">${r[0]}</div></div><div style="text-align:right"><div class="ws w4">${r[1]}</div><div class="wt">wines</div></div></div>`});
}
if(cellarFilter==='grapes'){
const sorted=Object.entries(cs.grapes).sort((a,b)=>b[1]-a[1]);
const total=cellarWines.length;
sorted.forEach((g,i)=>{const pct=Math.round(g[1]/total*100);h+=`<div class="wr" style="animation-delay:${Math.min(i*.03,.4)}s"><div class="wr-i"><div class="wr-n">${g[0]}</div><div class="wr-m"><div style="background:var(--border-d);border-radius:4px;height:4px;margin-top:6px;width:100%"><div style="background:var(--gold);height:4px;border-radius:4px;width:${pct}%"></div></div></div></div><div style="text-align:right"><div class="ws w4">${g[1]}</div><div class="wt">${pct}%</div></div></div>`});
}
if(cellarFilter==='insights'){
const topGrape=Object.entries(cs.grapes).sort((a,b)=>b[1]-a[1])[0];
const topRegion=Object.entries(cs.regions).sort((a,b)=>b[1]-a[1])[0];
const topCountry=Object.entries(cs.byCountry).sort((a,b)=>b[1]-a[1])[0];
const fives=cellarWines.filter(w=>w.rating>=5).length;
h+=`<div style="padding:4px 0">`;
const insights=[
{icon:'üçá',title:'Grape Loyalty',text:topGrape[1]+' of '+cs.total+' wines ('+Math.round(topGrape[1]/cs.total*100)+'%) are <b>'+topGrape[0]+'</b>. You know what you like.'},
{icon:'üìç',title:'Home Region',text:'<b>'+topRegion[0]+'</b> dominates with '+topRegion[1]+' wines. Your palate has a home base.'},
{icon:'üåç',title:'Top Country',text:'<b>'+topCountry[0]+'</b> leads with '+topCountry[1]+' wines across '+cs.countries+' countries explored.'},
{icon:'‚≠ê',title:'Standards',text:fives+' perfect 5-star ratings out of '+cs.total+'. You rate '+cs.avg+' on average ‚Äî generous but discerning.'},
{icon:'üî•',title:'Tempranillo Loyalist',text:(cs.grapes["Tempranillo"]||0)+' Tempranillos rated ‚Äî nearly 1 in 3. Spain runs through your veins.'},
{icon:'üß≠',title:'Explorer Index',text:cs.countries+' countries, '+Object.keys(cs.regions).length+' distinct regions. You drink wide but return to where it matters.'}
];
insights.forEach((ins,i)=>{h+=`<div class="cv" style="animation:fadeUp .3s ease-out ${i*.06}s both;margin-bottom:10px"><p><span style="font-size:18px;margin-right:6px">${ins.icon}</span><b style="color:var(--text)">${ins.title}</b><br>${ins.text}</p></div>`});
h+=`</div>`;
}
}
h+=`</div>`}

document.getElementById('app').innerHTML=h;
const ci=document.getElementById('ci'),li=document.getElementById('li');
if(ci){ci.addEventListener('input',e=>{S.city=e.target.value});ci.addEventListener('keydown',e=>{if(e.key==='Enter')go()})}
if(li)li.addEventListener('input',e=>{S.loc=e.target.value});
}
render();
</script>
</body>
</html>
