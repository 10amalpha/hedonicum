<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e17">
<title>Hedonicum ‚Äî Discover</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç∑</text></svg>">
<style>
:root {
  --bg: #0a0e17;
  --bg-card: #111827;
  --bg-card-hover: #151d2e;
  --gold: #d4a96a;
  --gold-dim: rgba(212, 169, 106, 0.12);
  --gold-border: rgba(212, 169, 106, 0.2);
  --text: #e2e8f0;
  --text-muted: #6b7a8d;
  --text-dim: #4a5568;
  --text-label: #3b4254;
  --border: #1e2538;
  --border-dim: #1a1f2e;
  --green: #48bb78;
  --green-dim: rgba(72, 187, 120, 0.15);
  --red: #e53e3e;
  --red-dim: rgba(229, 62, 62, 0.1);
  --font: -apple-system, 'system-ui', 'Segoe UI', Roboto, sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: 15px;
  line-height: 1.5;
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

@keyframes pulse { 0%,100%{opacity:.4} 50%{opacity:1} }
@keyframes slideUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* Toast */
.toast {
  position: fixed; top: env(safe-area-inset-top, 12px); left: 50%; transform: translateX(-50%);
  background: var(--bg-card); border: 1px solid var(--border);
  color: var(--text-muted); padding: 10px 24px; border-radius: 12px;
  font-size: 13px; z-index: 99; animation: fadeIn .2s;
  backdrop-filter: blur(8px);
}

/* Container */
.container {
  max-width: 480px; margin: 0 auto;
  padding: 0 20px;
  padding-top: max(env(safe-area-inset-top), 20px);
  padding-bottom: 100px;
}

/* Header */
.header {
  text-align: center;
  padding: 32px 0 28px;
}
.header h1 {
  font-size: 36px; font-weight: 800; color: var(--gold);
  letter-spacing: 0.5px; margin: 0;
}
.header .subtitle {
  color: var(--text-label); font-size: 11px;
  letter-spacing: 2.5px; text-transform: uppercase;
  margin-top: 6px;
}

/* Inputs */
.input-group { margin-bottom: 12px; }
.input-main {
  width: 100%; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 14px; color: var(--text); font-family: var(--font);
  font-size: 17px; padding: 16px 20px; outline: none;
  transition: border-color .2s;
}
.input-main:focus { border-color: var(--gold-border); }
.input-main::placeholder { color: var(--text-dim); }

.input-secondary {
  width: 100%; background: var(--bg-card); border: 1px solid var(--border-dim);
  border-radius: 12px; color: var(--text-muted); font-family: var(--font);
  font-size: 13px; padding: 12px 16px; outline: none;
  transition: border-color .2s;
}
.input-secondary:focus { border-color: var(--gold-border); }
.input-secondary::placeholder { color: var(--text-dim); }

/* Vibe filters */
.filters {
  display: flex; gap: 8px; margin-bottom: 12px; align-items: center;
}
.filter-group { display: flex; gap: 6px; flex: 1; }
.filter-btn {
  background: transparent; border: 1px solid var(--border-dim);
  border-radius: 10px; color: var(--text-dim); font-family: var(--font);
  font-size: 13px; padding: 10px 14px; cursor: pointer;
  transition: all .2s; font-weight: 500; flex: 1; text-align: center;
}
.filter-btn.active {
  background: var(--gold-dim); border-color: var(--gold-border);
  color: var(--gold);
}
.filter-btn:active { transform: scale(0.96); }

/* Discover button */
.discover-wrap { margin-bottom: 20px; }
.discover-btn {
  background: var(--gold); color: var(--bg); border: none;
  border-radius: 12px; padding: 14px 28px; font-family: var(--font);
  font-size: 15px; font-weight: 700; cursor: pointer;
  transition: all .2s; letter-spacing: 0.3px;
  width: 100%;
}
.discover-btn:active { transform: scale(0.96); opacity: 0.9; }
.discover-btn:disabled { opacity: 0.5; cursor: wait; }

/* Training stats */
.training-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0; margin-bottom: 16px;
}
.training-stats { font-size: 11px; color: var(--text-dim); }
.training-stats .loved { color: var(--green); }
.training-stats .rejected { color: var(--red); }
.training-reset {
  background: transparent; border: none; color: var(--text-dim);
  font-size: 11px; cursor: pointer; font-family: var(--font);
  padding: 4px 8px; border-radius: 6px;
}
.training-reset:active { background: var(--gold-dim); }

/* Loading */
.loading {
  text-align: center; padding: 60px 0;
  animation: pulse 2s ease-in-out infinite;
}
.loading-text { font-size: 16px; font-weight: 600; color: var(--text-dim); }
.loading-sub { color: var(--text-label); font-size: 12px; margin-top: 8px; }

/* Error */
.error { color: var(--red); text-align: center; padding: 24px; font-size: 14px; }

/* City vibe summary */
.city-vibe {
  background: var(--bg-card); border-radius: 16px;
  padding: 20px; margin-bottom: 16px;
  border-left: 3px solid var(--gold-border);
}
.city-vibe p { color: var(--text-muted); font-size: 14px; line-height: 1.7; }

/* Result cards */
.result-card {
  background: var(--bg-card); border-radius: 14px;
  padding: 18px 16px; margin-bottom: 8px;
  border: 1px solid var(--border-dim);
  transition: all .3s;
  position: relative;
}
.result-card.loved-card { border-color: rgba(72, 187, 120, 0.3); }
.result-card.rejected-card {
  opacity: 0.12; max-height: 0; padding: 0 !important;
  margin: 0 !important; overflow: hidden; border: none;
}

.card-top { display: flex; justify-content: space-between; align-items: flex-start; }
.card-info { flex: 1; min-width: 0; }
.card-name-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.card-name {
  font-size: 16px; font-weight: 700; color: var(--text);
  text-decoration: none; display: block;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 220px;
}
.card-name:active { color: var(--gold); }
.card-cuisine { font-size: 11px; color: var(--text-dim); font-weight: 500; }
.card-price { font-size: 12px; color: var(--green); font-weight: 600; }
.card-location { color: var(--text-label); font-size: 12px; margin-top: 4px; }
.card-location .walk { color: var(--text-dim); margin-left: 6px; }

/* Score + action buttons */
.card-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.action-btn {
  background: transparent; border: 1px solid var(--border-dim);
  border-radius: 10px; width: 36px; height: 36px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; transition: all .15s; color: var(--text-dim);
}
.action-btn:active { transform: scale(0.9); }
.action-btn.love-active { background: var(--green-dim); border-color: rgba(72,187,120,0.3); color: var(--green); }
.action-btn.reject-active { background: var(--red-dim); border-color: rgba(229,62,62,0.2); color: var(--red); }

.card-score {
  text-align: center; min-width: 38px;
}
.score-num {
  font-size: 28px; font-weight: 800; line-height: 1;
}
.score-9 { color: var(--gold); }
.score-7 { color: #b8956a; }
.score-5 { color: var(--text-dim); }
.score-low { color: var(--text-label); }

/* Spirit text */
.card-spirit { color: var(--text-muted); font-size: 13px; line-height: 1.6; margin-top: 10px; }

/* Maps link */
.card-maps {
  color: var(--gold); font-size: 12px; text-decoration: none;
  display: inline-flex; align-items: center; gap: 4px;
  margin-top: 10px; opacity: 0.6; font-weight: 500;
}
.card-maps:active { opacity: 1; }

/* Footer */
.results-footer {
  text-align: center; margin: 40px 0 20px;
  color: var(--text-label); font-size: 11px; letter-spacing: 1px;
}

/* Empty state */
.empty { text-align: center; margin-top: 48px; }
.empty-text {
  font-size: 17px; color: var(--text-dim); font-weight: 300;
  line-height: 1.6;
}
.city-pills {
  display: flex; gap: 8px; justify-content: center; margin-top: 24px;
  flex-wrap: wrap;
}
.city-pill {
  background: transparent; border: 1px solid var(--border);
  border-radius: 20px; color: var(--text-dim); font-family: var(--font);
  font-size: 13px; padding: 8px 18px; cursor: pointer;
  transition: all .2s; font-weight: 500;
}
.city-pill:active { border-color: var(--gold-border); color: var(--gold); transform: scale(0.96); }

/* Safe area for bottom */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .container { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
}

/* Larger screens */
@media (min-width: 600px) {
  .container { padding: 20px 32px 40px; }
  .header { padding: 48px 0 36px; }
  .header h1 { font-size: 42px; }
  .card-name { max-width: 320px; }
}
</style>
</head>
<body>
<div class="container" id="app"></div>
<script>
const API = "https://wine-profile.vercel.app/api/analyze";

const TASTE = `DINER PATTERN (what unites their 790 favorite venues across 31 countries):
1. SOUL over concept ‚Äî chef passion > design. Rintaro, Isolina, Taberna Antonio Sanchez
2. INGREDIENT-DRIVEN ‚Äî product is star. Bar Crudo, PPQ Dungeness, Parador La Huella
3. NEIGHBORHOOD-ROOTED ‚Äî locals eat here. Burma Superstar, Halu, La Carmencita
4. WINE AS COMPANION ‚Äî always part of the meal. Corks wine bar (38x), wineries (72 visits)
5. UNPRETENTIOUS QUALITY ‚Äî no dress code, serious food. El Che, Underdogs Tres
6. CULTURAL AUTHENTICITY ‚Äî teaches you about its cuisine. Rintaro, Isolina
7. FIRE AND SEA ‚Äî grilled, raw seafood, wood-fired
8. REGULARS' PLACE ‚Äî owner knows you after 3 visits
AVOIDS: tourist traps, chains, hotel restaurants, molecular gimmicks, Instagram-famous

NIGHTLIFE: neighborhood pubs (206x), craft cocktails (74x), dive bars (34x), natural wine bars (72x), breweries (15x)

LOYALTY REFS: Burma Superstar (Burmese SF 39x), Corks (wine bar Medellin 38x), Rintaro (izakaya SF), Bar Crudo (raw bar SF), Parador La Huella (beach Uruguay), La Carmencita (vermouth Madrid), Halu (izakaya SF), Isolina (Peruvian Lima), Taberna Antonio Sanchez (tapas Madrid), El Che (grill Medellin)`;

let S = { city:"", location:"", vibe:"all", loading:false, phase:"", results:null, error:"", loved:{}, rejected:{}, toast:"" };

try { S.loved = JSON.parse(localStorage.getItem("hedonicum-loved")||"{}"); } catch {}
try { S.rejected = JSON.parse(localStorage.getItem("hedonicum-rejected")||"{}"); } catch {}

function saveLoved() { localStorage.setItem("hedonicum-loved", JSON.stringify(S.loved)); }
function saveRejected() { localStorage.setItem("hedonicum-rejected", JSON.stringify(S.rejected)); }

function toast(msg) { S.toast=msg; render(); setTimeout(()=>{S.toast="";render()},2000); }

function toggleLove(n) {
  if(S.loved[n]){delete S.loved[n];toast("Removed");}else{S.loved[n]=true;toast("‚ô• Saved to taste");}
  if(S.loved[n]&&S.rejected[n]){delete S.rejected[n];saveRejected();}
  saveLoved();render();
}
function toggleReject(n) {
  if(S.rejected[n]){delete S.rejected[n];toast("Restored");}else{S.rejected[n]=true;toast("‚úï Dismissed");}
  if(S.rejected[n]&&S.loved[n]){delete S.loved[n];saveLoved();}
  saveRejected();render();
}
function clearAll() {
  S.loved={};S.rejected={};localStorage.removeItem("hedonicum-loved");localStorage.removeItem("hedonicum-rejected");
  toast("Training reset");render();
}

function feedback() {
  const lk=Object.keys(S.loved),rk=Object.keys(S.rejected); let c="";
  if(lk.length) c+=`\n\nUSER-CONFIRMED LOVES (find MORE like these):\n${lk.map(n=>"  ‚ô• "+n).join("\n")}`;
  if(rk.length) c+=`\n\nUSER-REJECTED (AVOID similar):\n${rk.map(n=>"  ‚úï "+n).join("\n")}`;
  return c;
}

async function callAPI(system,user,model,search) {
  const b={system,messages:[{role:"user",content:user}],max_tokens:3000};
  if(model)b.model=model;
  if(search)b.tools=[{type:"web_search_20250305",name:"web_search"}];
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});
  return await r.json();
}

function text(d){return(d.content||[]).filter(b=>b.type==="text").map(b=>b.text).join("\n");}
function json(t){const c=t.replace(/```json|```/g,"").trim();const s=c.indexOf("{"),e=c.lastIndexOf("}");return s>=0?JSON.parse(c.substring(s,e+1)):null;}

const VM={all:"restaurants, bars, and wine spots",restaurant:"restaurants and cafes only",bar:"bars, pubs, cocktail bars, dive bars",wine:"wine bars, natural wine spots, enotecas, vinotecas"};

async function go() {
  if(!S.city.trim()||S.loading)return;
  S.loading=true;S.error="";S.results=null;render();
  const loc=S.location.trim()?`near ${S.location.trim()} (within 30 min walking distance)`:"";
  const fb=feedback();
  try {
    S.phase="Searching for real places...";render();
    const sr=await callAPI("You are a restaurant researcher. Search the web and return only REAL, currently operating places. Never invent names.",
      `Search for the best ${VM[S.vibe]} in ${S.city}${loc?" "+loc:""}. Quality-focused, local favorites, hidden gems. Search 3-4 different queries. List 12-18 real places: name, neighborhood, cuisine, price range.`,
      "claude-sonnet-4-20250514",true);
    const found=text(sr);
    if(!found||found.length<20){S.error="Couldn't find places. Try a larger area.";S.loading=false;render();return;}

    S.phase="Matching to your palate...";render();
    const wc=S.location.trim()?`Diner is near: ${S.location.trim()}. Include walking time.`:"Include neighborhood.";
    const sc=await callAPI(
      `You score places against a diner's taste pattern.\n\n${TASTE}${fb}\n\nRespond ONLY with valid JSON:\n{"city_vibe":"2-3 sentences","restaurants":[{"name":"exact name","neighborhood":"area","cuisine":"type","price":"$$","walk":"time or area","spirit":"which loyalty venue this echoes, 1 sentence","score":8,"q":"name city for maps"}]}\nSort by score desc.`,
      `City: ${S.city}\n${wc}\nCategory: ${VM[S.vibe]}\n\nPlaces found:\n${found}\n\nScore each. Only include places from the search results.`,
      "claude-sonnet-4-20250514",false);
    const p=json(text(sc));
    if(p?.restaurants?.length)S.results=p; else S.error="Couldn't score results. Try again.";
  } catch(e){S.error="Error: "+e.message;}
  S.loading=false;S.phase="";render();
}

function scoreClass(s){return s>=9?"score-9":s>=7?"score-7":s>=5?"score-5":"score-low";}
function maps(r){return`https://www.google.com/maps/search/${encodeURIComponent(r.q||r.name+" "+S.city)}`;}
function esc(n){return n.replace(/'/g,"\\'").replace(/"/g,"&quot;");}

function render() {
  const lc=Object.keys(S.loved).length, rc=Object.keys(S.rejected).length;
  const vibes=[{id:"all",l:"All"},{id:"restaurant",l:"Eat"},{id:"bar",l:"Drink"},{id:"wine",l:"Wine"}];
  let h='';

  if(S.toast) h+=`<div class="toast">${S.toast}</div>`;

  h+=`<div class="header"><h1>Hedonicum</h1><div class="subtitle">Discover</div></div>`;

  h+=`<div class="input-group"><input class="input-main" id="ci" value="${S.city}" placeholder="Where are you going?"></div>`;
  h+=`<div class="input-group"><input class="input-secondary" id="li" value="${S.location}" placeholder="Staying near? (hotel, address, neighborhood)"></div>`;

  h+=`<div class="filters"><div class="filter-group">`;
  vibes.forEach(v=>{
    h+=`<button class="filter-btn${S.vibe===v.id?' active':''}" onclick="S.vibe='${v.id}';render()">${v.l}</button>`;
  });
  h+=`</div></div>`;
  h+=`<div class="discover-wrap"><button class="discover-btn" onclick="go()" ${S.loading?'disabled':''}>${S.loading?'¬∑¬∑¬∑':'Discover'}</button></div>`;

  if((lc>0||rc>0)&&!S.loading){
    h+=`<div class="training-bar"><div class="training-stats">`;
    if(lc>0) h+=`<span class="loved">‚ô• ${lc}</span>`;
    if(lc>0&&rc>0) h+=` ¬∑ `;
    if(rc>0) h+=`<span class="rejected">‚úï ${rc}</span>`;
    h+=`<span style="color:var(--text-label);margin-left:6px">shaping taste</span></div>`;
    h+=`<button class="training-reset" onclick="clearAll()">Reset</button></div>`;
  }

  if(S.loading){
    h+=`<div class="loading"><div class="loading-text">${S.phase}</div>`;
    if(S.location) h+=`<div class="loading-sub">Within 30 min walk of ${S.location}</div>`;
    h+=`</div>`;
  }

  if(S.error) h+=`<div class="error">${S.error}</div>`;

  if(S.results){
    h+=`<div class="city-vibe"><p>${S.results.city_vibe}</p></div>`;

    S.results.restaurants.forEach((r,i)=>{
      const isL=S.loved[r.name],isR=S.rejected[r.name];
      const en=esc(r.name);
      h+=`<div class="result-card${isL?' loved-card':''}${isR?' rejected-card':''}" style="animation:slideUp .35s ease-out ${i*.04}s both">`;
      h+=`<div class="card-top"><div class="card-info">`;
      h+=`<div class="card-name-row"><a href="${maps(r)}" target="_blank" class="card-name">${r.name}</a>`;
      h+=`<span class="card-cuisine">${r.cuisine}</span>`;
      if(r.price) h+=`<span class="card-price">${r.price}</span>`;
      h+=`</div>`;
      h+=`<div class="card-location">${r.neighborhood}${r.walk?`<span class="walk">¬∑ ${r.walk}</span>`:''}</div>`;
      h+=`</div>`;

      h+=`<div class="card-actions">`;
      h+=`<button class="action-btn${isR?' reject-active':''}" onclick="toggleReject('${en}')">‚úï</button>`;
      h+=`<div class="card-score"><div class="score-num ${scoreClass(r.score)}">${r.score}</div></div>`;
      h+=`<button class="action-btn${isL?' love-active':''}" onclick="toggleLove('${en}')">‚ô•</button>`;
      h+=`</div></div>`;

      h+=`<p class="card-spirit">${r.spirit}</p>`;
      h+=`<a href="${maps(r)}" target="_blank" class="card-maps">‚Üí Google Maps</a>`;
      h+=`</div>`;
    });

    h+=`<div class="results-footer">Web-verified ¬∑ Pattern-matched ¬∑ ‚ô• ‚úï train your taste</div>`;
  }

  if(!S.loading&&!S.results&&!S.error){
    h+=`<div class="empty"><p class="empty-text">Not where you've been.<br>Where you should go.</p>`;
    h+=`<div class="city-pills">`;
    ["Tokyo","Lisbon","Buenos Aires","Copenhagen","El Retiro","Barcelona","CDMX","Berlin"].forEach(c=>{
      h+=`<button class="city-pill" onclick="S.city='${c}';render();document.getElementById('ci').value='${c}'">${c}</button>`;
    });
    h+=`</div></div>`;
  }

  document.getElementById('app').innerHTML=h;

  const ci=document.getElementById('ci'), li=document.getElementById('li');
  if(ci){
    ci.addEventListener('input',e=>{S.city=e.target.value;});
    ci.addEventListener('keydown',e=>{if(e.key==='Enter')go();});
    if(!S.loading&&!S.results) ci.focus();
  }
  if(li) li.addEventListener('input',e=>{S.location=e.target.value;});
}

render();
</script>
</body>
</html>
